<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Viajes - Lara</title>
  <link rel="manifest" href="/Lara/manifest.json" />
  <style>
    :root{--accent:#6f42c1;--muted:#666;--danger:#dc3545}
    body{font-family:Inter, system-ui, Arial;margin:0;padding:1rem;background:#f6f9ff;color:#111}
    .wrap{max-width:980px;margin:0 auto}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:1rem}
    .controls{display:flex;gap:.5rem;align-items:center}
    .card{background:#fff;padding:1rem;border-radius:12px;box-shadow:0 8px 24px rgba(12,20,55,0.06);margin-top:1rem}
    .row{display:flex;gap:.5rem;flex-wrap:wrap}
    input,select,textarea{padding:.6rem;border-radius:8px;border:1px solid #e6eef7;font-size:1rem}
    .btn{background:var(--accent);color:white;border:0;padding:.6rem .9rem;border-radius:10px;cursor:pointer;font-weight:500}
    .btn.secondary{background:#6c757d}
    .btn.danger{background:var(--danger)}
    table{width:100%;border-collapse:collapse;margin-top:1rem}
    th,td{padding:.8rem;border-bottom:1px solid #eef4ff;text-align:left}
    th{background:#f8faff;font-weight:600;color:var(--muted)}
    .muted{color:var(--muted)}
    .small{font-size:.9rem}
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.4);z-index:100}
    .panel{background:white;padding:1.5rem;border-radius:16px;width:95%;max-width:620px;box-shadow:0 20px 40px rgba(0,0,0,0.2)}
    .flex-space{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:1rem}
    .badge{padding:.2rem .5rem;border-radius:6px;font-size:.8rem;font-weight:bold;text-transform:uppercase}
    .badge-cotizacion{background:#fff3bf;color:#f08c00}
    .badge-programado{background:#e7f5ff;color:#007bff}
    .badge-realizado{background:#ebfbee;color:#40c057}
    @media (max-width: 600px) {
      .row > * { flex: 1 1 100%; }
      table, thead, tbody, th, td, tr { display: block; }
      thead tr { position: absolute; top: -9999px; left: -9999px; }
      tr { border: 1px solid #eee; margin-bottom: 1rem; border-radius: 8px; padding: .5rem; }
      td { border: none; position: relative; padding-left: 50%; }
      td:before { position: absolute; left: 10px; width: 45%; padding-right: 10px; white-space: nowrap; content: attr(data-label); font-weight: bold; color: var(--muted); }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Viajes</h1>
      <nav class="controls">
        <a class="small" href="/Lara/index.html">Inicio</a>
        <a class="small" href="/Lara/registros.html">Registros</a>
        <a class="small" href="/Lara/diezmos.html">Diezmos</a>
      </nav>
    </header>

    <div class="card">
      <div class="flex-space">
        <div class="controls">
          <button id="openNew" class="btn">+ Nuevo Viaje</button>
          <button id="exportJson" class="btn secondary">JSON</button>
          <button id="importJson" class="btn secondary">Importar</button>
          <button id="exportPdf" class="btn">PDF</button>
          <input id="fileInput" type="file" accept="application/json" style="display:none" />
        </div>
        <div class="small muted">Datos locales</div>
      </div>

      <div style="margin-top:1.5rem; background:#f8faff; padding:1rem; border-radius:10px" class="row">
        <div style="flex:1"><label class="small muted">Desde</label><br><input id="filterFrom" type="date" style="width:100%; box-sizing:border-box" /></div>
        <div style="flex:1"><label class="small muted">Hasta</label><br><input id="filterTo" type="date" style="width:100%; box-sizing:border-box" /></div>
        <div style="align-self:end"><button id="applyFilter" class="btn secondary" style="width:100%">Filtrar</button></div>
      </div>

      <div style="overflow-x:auto">
        <table id="table">
          <thead><tr><th>Fecha</th><th>Cliente</th><th>Ruta</th><th>Estado</th><th>Condición</th><th>Acciones</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="modal" id="modal">
    <div class="panel">
      <h3 id="modalTitle" style="margin-top:0">Nuevo viaje</h3>
      <form id="form">
        <div class="row" style="margin-top:.5rem">
          <div style="flex:1">
            <label class="small muted">Fecha</label>
            <input id="fecha" type="date" required style="width:100%; box-sizing:border-box" />
          </div>
          <div style="flex:1">
            <label class="small muted">Cliente</label>
            <input id="cliente" placeholder="Nombre del cliente" style="width:100%; box-sizing:border-box" />
          </div>
        </div>
        <div class="row" style="margin-top:1rem">
          <div style="flex:1">
            <label class="small muted">Ruta Inicio</label>
            <input id="rutaInicio" placeholder="Origen" style="width:100%; box-sizing:border-box" />
          </div>
          <div style="flex:1">
            <label class="small muted">Ruta Fin</label>
            <input id="rutaFin" placeholder="Destino" style="width:100%; box-sizing:border-box" />
          </div>
        </div>
        <div class="row" style="margin-top:1rem">
          <div style="flex:1">
            <label class="small muted">Estado</label>
            <select id="estado" style="width:100%">
              <option value="cotización">Cotización</option>
              <option value="programado">Programado</option>
              <option value="realizado">Realizado</option>
            </select>
          </div>
          <div style="flex:1">
            <label class="small muted">Condición (opcional)</label>
            <input id="condicion" placeholder="Ej. Pago contra entrega" style="width:100%; box-sizing:border-box" />
          </div>
        </div>
        <div style="margin-top:1rem">
          <label class="small muted">Detalle adicional</label>
          <textarea id="detalle" placeholder="Notas del viaje..." style="width:100%; box-sizing:border-box; height:60px"></textarea>
        </div>
        <div style="text-align:right;margin-top:1.5rem; display:flex; gap:.5rem; justify-content:flex-end">
          <button type="button" id="cancel" class="btn secondary">Cancelar</button>
          <button type="submit" class="btn">Guardar</button>
        </div>
      </form>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    const KEY = 'viajes_v1';
    let data = JSON.parse(localStorage.getItem(KEY) || '[]');
    const tbody = document.querySelector('#table tbody');
    const modal = document.getElementById('modal');
    const form = document.getElementById('form');
    let editingId = null;

    function render(){
      tbody.innerHTML = '';
      const from = document.getElementById('filterFrom').value ? new Date(document.getElementById('filterFrom').value) : null;
      const to = document.getElementById('filterTo').value ? new Date(document.getElementById('filterTo').value) : null;
      
      const filtered = data.slice().sort((a,b)=>b.created-a.created).filter(r=>{
        const d = new Date(r.fecha);
        if(from && d < from) return false;
        if(to && d > to) return false;
        return true;
      });

      filtered.forEach(r=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td data-label="Fecha">${r.fecha}</td>
          <td data-label="Cliente">${r.cliente || '-'}</td>
          <td data-label="Ruta" class="small">${r.rutaInicio} → ${r.rutaFin}</td>
          <td data-label="Estado"><span class="badge badge-${r.estado.replace('ó','o')}">${r.estado}</span></td>
          <td data-label="Condición" class="small">${r.condicion || '-'}</td>
          <td data-label="Acciones">
            <button onclick="openEdit(${r.id})" class="btn small" style="padding:.3rem .6rem">Editar</button>
            <button onclick="deleteItem(${r.id})" class="btn danger small" style="padding:.3rem .6rem">X</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    document.getElementById('openNew').addEventListener('click', ()=>{
      editingId = null;
      document.getElementById('modalTitle').textContent = 'Nuevo viaje';
      form.reset();
      document.getElementById('fecha').value = new Date().toISOString().slice(0,10);
      modal.style.display = 'flex';
    });

    document.getElementById('cancel').addEventListener('click', ()=> modal.style.display = 'none');

    form.addEventListener('submit', e=>{
      e.preventDefault();
      const entry = {
        id: editingId || Date.now(),
        fecha: document.getElementById('fecha').value,
        cliente: document.getElementById('cliente').value.trim(),
        rutaInicio: document.getElementById('rutaInicio').value.trim(),
        rutaFin: document.getElementById('rutaFin').value.trim(),
        estado: document.getElementById('estado').value,
        condicion: document.getElementById('condicion').value.trim(),
        detalle: document.getElementById('detalle').value.trim(),
        created: editingId ? data.find(x=>x.id===editingId).created : Date.now()
      };

      if(editingId){
        const idx = data.findIndex(x=>x.id === editingId);
        data[idx] = entry;
      } else {
        data.unshift(entry);
      }

      localStorage.setItem(KEY, JSON.stringify(data));
      modal.style.display = 'none';
      render();
    });

    window.openEdit = (id) => {
      const item = data.find(x=>x.id === id);
      if(!item) return;
      editingId = item.id;
      document.getElementById('modalTitle').textContent = 'Editar viaje';
      document.getElementById('fecha').value = item.fecha;
      document.getElementById('cliente').value = item.cliente || '';
      document.getElementById('rutaInicio').value = item.rutaInicio;
      document.getElementById('rutaFin').value = item.rutaFin;
      document.getElementById('estado').value = item.estado;
      document.getElementById('condicion').value = item.condicion || '';
      document.getElementById('detalle').value = item.detalle || '';
      modal.style.display = 'flex';
    };

    window.deleteItem = (id) => {
      if(confirm('¿Eliminar este viaje?')){
        data = data.filter(x=>x.id !== id);
        localStorage.setItem(KEY, JSON.stringify(data));
        render();
      }
    };

    document.getElementById('applyFilter').addEventListener('click', render);

    document.getElementById('exportJson').addEventListener('click', ()=>{
      const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `Lara_Viajes_${new Date().toISOString().slice(0,10)}.json`;
      a.click();
    });

    document.getElementById('importJson').addEventListener('click', ()=> document.getElementById('fileInput').click());
    document.getElementById('fileInput').addEventListener('change', e=>{
      const f = e.target.files[0];
      if(!f) return;
      const reader = new FileReader();
      reader.onload = ()=>{
        try {
          const imp = JSON.parse(reader.result);
          if(Array.isArray(imp)){
            data = [...imp, ...data].filter((v,i,a)=>a.findIndex(t=>(t.id===v.id))===i);
            localStorage.setItem(KEY, JSON.stringify(data));
            render();
            alert('Viajes importados');
          }
        } catch(er){ alert('Error: ' + er.message); }
      };
      reader.readAsText(f);
    });

    document.getElementById('exportPdf').addEventListener('click', ()=>{
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.setFontSize(18);
      doc.text('Reporte de Viajes - Lara', 14, 20);
      
      let y = 40;
      doc.setFontSize(10);
      data.slice(0, 100).forEach(r => {
        doc.text(`${r.fecha} | ${r.cliente || 'S/C'} | ${r.rutaInicio} -> ${r.rutaFin} | ${r.estado}`, 14, y);
        y += 6;
        if(r.detalle) {
          doc.setFontSize(8);
          doc.setTextColor(100);
          doc.text(`Nota: ${r.detalle}`, 20, y);
          doc.setFontSize(10);
          doc.setTextColor(0);
          y += 6;
        }
        if(y > 280) { doc.addPage(); y = 20; }
      });
      doc.save('Lara_Viajes.pdf');
    });

    render();
  </script>
</body>
</html>
