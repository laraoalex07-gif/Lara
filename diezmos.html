<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Diezmos - Lara</title>
  <link rel="manifest" href="/Lara/manifest.json" />
  <style>
    :root{--accent:#00c896;--muted:#666}
    body{font-family:Inter, system-ui, Arial;margin:0;padding:1rem;background:#f7fffb;color:#111}
    .wrap{max-width:980px;margin:0 auto}
    header{display:flex;align-items:center;justify-content:space-between}
    .card{background:#fff;padding:1rem;border-radius:12px;box-shadow:0 8px 24px rgba(12,20,55,0.06);margin-top:1rem}
    .row{display:flex;gap:.5rem}
    input,select{padding:.6rem;border-radius:8px;border:1px solid #e6eef7}
    .btn{background:var(--accent);color:white;border:0;padding:.6rem .9rem;border-radius:10px;cursor:pointer}
    .btn.secondary{background:#666}
    table{width:100%;border-collapse:collapse;margin-top:1rem}
    th,td{padding:.6rem;border-bottom:1px solid #eef4ff;text-align:left}
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.4)}
    .panel{background:white;padding:1rem;border-radius:10px;width:95%;max-width:520px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Diezmos</h1>
      <nav>
        <a class="small" href="/Lara/index.html">Inicio</a>
        <a class="small" href="/Lara/registros.html">Registros</a>
        <a class="small" href="/Lara/viajes.html">Viajes</a>
      </nav>
    </header>

    <div class="card">
      <div class="row" style="align-items:center;gap:1rem">
        <div>
          <label class="small">Mes</label>
          <input id="month" type="month" />
        </div>
        <div>
          <label class="small">Quincena</label>
          <select id="quincena"><option value="1">1 (día 1-15)</option><option value="2">2 (día 16-fin)</option></select>
        </div>
        <div style="align-self:end">
          <button id="calcBtn" class="btn">Calcular</button>
        </div>
      </div>

      <div style="margin-top:1rem">
        <div id="resultBox" class="small"></div>
        <div style="margin-top:.6rem">
          <button id="openPay" class="btn">Registrar pago</button>
          <button id="exportJson" class="btn secondary">Exportar pagos JSON</button>
          <button id="exportPdf" class="btn">Exportar PDF pagos</button>
        </div>
      </div>

      <div style="margin-top:1rem">
        <h3>Historial de pagos</h3>
        <table id="table"><thead><tr><th>Fecha</th><th>Monto</th><th>Método</th><th>Quincena</th><th>Acciones</th></tr></thead><tbody></tbody></table>
      </div>
    </div>
  </div>

  <!-- payment modal -->
  <div class="modal" id="payModal"><div class="panel"><h3>Registrar pago</h3><form id="payForm"><div class="row" style="margin-top:.5rem"><input id="payDate" type="date" required /><input id="payAmount" type="number" step="0.01" required /><select id="payMethod"><option value="efectivo">Efectivo</option><option value="transferencia">Transferencia</option></select></div><div style="text-align:right;margin-top:.6rem"><button type="button" id="cancelPay" class="btn secondary">Cancelar</button><button type="submit" class="btn">Guardar pago</button></div></form></div></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    const KEY_REG = 'registros_v2';
    const KEY_PAG = 'pagos_diezmos_v1';
    let registros = JSON.parse(localStorage.getItem(KEY_REG) || '[]');
    let pagos = JSON.parse(localStorage.getItem(KEY_PAG) || '[]');

    const monthEl = document.getElementById('month');
    const quincenaEl = document.getElementById('quincena');
    const resultBox = document.getElementById('resultBox');
    const calcBtn = document.getElementById('calcBtn');
    const openPay = document.getElementById('openPay');
    const payModal = document.getElementById('payModal');
    const payForm = document.getElementById('payForm');
    const payDate = document.getElementById('payDate');
    const payAmount = document.getElementById('payAmount');
    const payMethod = document.getElementById('payMethod');
    const tableBody = document.querySelector('#table tbody');

    function formatQ(n){ return 'Q.' + Number(n||0).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2}); }

    function firstDayOfMonth(y,m){ return new Date(y,m,1); }
    function lastDayOfMonth(y,m){ return new Date(y,m+1,0); }

    function quincenaRange(year, monthIndex, q){
      if(q===1) return {from: new Date(year,monthIndex,1), to: new Date(year,monthIndex,15,23,59,59,999)};
      return {from: new Date(year,monthIndex,16), to: lastDayOfMonth(year,monthIndex)};
    }

    function calcForSelected(){
      const val = monthEl.value || new Date().toISOString().slice(0,7);
      const [y, m] = val.split('-').map(Number);
      const q = Number(quincenaEl.value);
      const range = quincenaRange(y, m-1, q);
      // sum ingresos & gastos from registros
      let ingresos=0, gastos=0;
      registros.forEach(r=>{
        const d = new Date(r.fecha);
        if(d>=range.from && d<=range.to){ if(r.tipo==='ingreso') ingresos += Number(r.monto||0); else if(r.tipo==='gasto') gastos += Number(r.monto||0); }
      });
      let base = ingresos - gastos; if(base < 0) base = 0; const diezmo = Math.round(base * 0.10 *100)/100;
      const key = `${y}-${String(m).padStart(2,'0')}-${q}`;
      // payments for this quincena
      const pagosThis = pagos.filter(p=>p.quincenaKey===key);
      const pagado = pagosThis.reduce((s,p)=>s+Number(p.monto||0),0);
      const faltante = Math.max(0, diezmo - pagado);
      resultBox.innerHTML = `<div>Quincena: <strong>${y}-${String(m).padStart(2,'0')} q${q}</strong></div><div>Ingresos: <strong>${formatQ(ingresos)}</strong> Gastos: <strong>${formatQ(gastos)}</strong></div><div>Sugerido (10%): <strong>${formatQ(diezmo)}</strong></div><div>Pagado: <strong>${formatQ(pagado)}</strong> Faltante: <strong>${formatQ(faltante)}</strong></div>`;
      renderPayments();
      return {key,diezmo,pagado,faltante,range};
    }

    function renderPayments(){
      const val = monthEl.value || new Date().toISOString().slice(0,7); const [y,m] = val.split('-').map(Number); const q = Number(quincenaEl.value); const key = `${y}-${String(m).padStart(2,'0')}-${q}`;
      const list = pagos.filter(p=>p.quincenaKey===key).slice().sort((a,b)=>b.created-a.created);
      tableBody.innerHTML='';
      list.forEach(p=>{
        const tr=document.createElement('tr'); tr.innerHTML = `<td>${p.fecha}</td><td>${formatQ(p.monto)}</td><td>${p.metodo}</td><td>${p.quincenaKey}</td><td><button data-id="${p.id}" class="btn">Editar</button> <button data-iddel="${p.id}" class="btn secondary">Eliminar</button></td>`; tableBody.appendChild(tr);
      });
      tableBody.querySelectorAll('button[data-iddel]').forEach(b=>b.addEventListener('click', e=>{ deletePay(e.currentTarget.dataset.id); }));
      tableBody.querySelectorAll('button[data-id]').forEach(b=>b.addEventListener('click', e=>{ editPay(e.currentTarget.dataset.id); }));
    }

    function deletePay(id){ if(!confirm('Eliminar pago?')) return; pagos = pagos.filter(p=>String(p.id)!==String(id)); localStorage.setItem(KEY_PAG, JSON.stringify(pagos)); calcForSelected(); }

    function editPay(id){ const p = pagos.find(x=>String(x.id)===String(id)); if(!p) return; payDate.value = p.fecha; payAmount.value = p.monto; payMethod.value = p.metodo; payModal.style.display='flex'; editingPayId = p.id; }

    let editingPayId = null;
    calcBtn.addEventListener('click', (e)=>{ e.preventDefault(); calcForSelected(); });
    openPay.addEventListener('click', ()=>{ const res = calcForSelected(); payModal.style.display='flex'; // default values
      const today = new Date().toISOString().slice(0,10); payDate.value = today; payAmount.value = res.diezmo; payMethod.value='efectivo'; editingPayId = null; });
    document.getElementById('cancelPay').addEventListener('click', ()=>{ payModal.style.display='none'; editingPayId=null; });

    payForm.addEventListener('submit', e=>{
      e.preventDefault();
      const fecha = payDate.value || new Date().toISOString().slice(0,10);
      const monto = parseFloat(payAmount.value) || 0;
      const metodo = payMethod.value;
      const val = monthEl.value || new Date().toISOString().slice(0,7); const [y,m] = val.split('-').map(Number); const q = Number(quincenaEl.value); const key = `${y}-${String(m).padStart(2,'0')}-${q}`;
      if(editingPayId){ const idx = pagos.findIndex(p=>p.id===editingPayId); if(idx>-1){ pagos[idx] = {...pagos[idx], fecha, monto, metodo}; } }
      else { pagos.unshift({id:Date.now(), fecha, monto, metodo, quincenaKey:key, created:Date.now()}); }
      localStorage.setItem(KEY_PAG, JSON.stringify(pagos)); payModal.style.display='none'; editingPayId=null; calcForSelected();
    });

    function deleteAllForDemo(){ }

    // Export payments JSON
    document.getElementById('exportJson').addEventListener('click', ()=>{ const b = new Blob([JSON.stringify(pagos,null,2)],{type:'application/json'}); const u=URL.createObjectURL(b); const a=document.createElement('a'); a.href=u; a.download='pagos_diezmos.json'; a.click(); URL.revokeObjectURL(u); });
    document.getElementById('exportPdf').addEventListener('click', ()=>{ const { jsPDF } = window.jspdf; const doc = new jsPDF(); let y=10; doc.text('Pagos diezmos',10,y); y+=8; pagos.slice(0,200).forEach(p=>{ doc.text(`${p.fecha} ${p.quincenaKey} ${formatQ(p.monto)} ${p.metodo}`,10,y); y+=6; if(y>280){doc.addPage(); y=10;} }); doc.save('pagos_diezmos.pdf'); });

    // Init defaults
    (function init(){ const now = new Date(); monthEl.value = now.toISOString().slice(0,7); calcForSelected(); if('serviceWorker' in navigator) navigator.serviceWorker.register('/Lara/sw.js').catch(()=>{}); })();
  </script>
</body>
</html>