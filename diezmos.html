<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Diezmos</title>
  <link rel="manifest" href="/manifest.json" />
  <style>
    body{font-family: Arial, Helvetica, sans-serif;padding:20px;max-width:900px;margin:auto}
    header{display:flex;justify-content:space-between;align-items:center}
    .list{margin-top:20px}
    .item{padding:8px;border:1px solid #ddd;border-radius:4px;margin-bottom:8px;display:flex;justify-content:space-between}
    .controls{display:flex;gap:8px}
    .modal{position:fixed;left:0;top:0;right:0;bottom:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center}
    .modal .panel{background:#fff;padding:16px;border-radius:6px;max-width:500px;width:95%}
    .hidden{display:none}
    .btn{padding:6px 10px;border:none;background:#1976d2;color:#fff;border-radius:4px;cursor:pointer}
    .btn.secondary{background:#666}
    .row{display:flex;gap:8px}
  </style>
</head>
<body>
  <header>
    <h1>Diezmos</h1>
    <nav>
      <a href="registros.html">Registros</a> | <a href="viajes.html">Viajes</a>
    </nav>
  </header>

  <section>
    <form id="form">
      <div class="row">
        <input id="name" placeholder="Nombre" required />
        <input id="amount" type="number" step="0.01" placeholder="Monto" required />
        <input id="date" type="date" />
      </div>
      <div style="margin-top:8px">
        <input id="notes" placeholder="Notas" />
      </div>
      <div style="margin-top:8px">
        <button class="btn" type="submit">Agregar</button>
        <button class="btn secondary" type="button" id="exportBtn">Exportar JSON</button>
        <button class="btn secondary" type="button" id="importBtn">Importar JSON</button>
        <button class="btn" type="button" id="pdfBtn">Exportar PDF</button>
        <input id="fileInput" type="file" accept="application/json" class="hidden" />
      </div>
    </form>

    <div class="list" id="list"></div>
  </section>

  <!-- Edit modal -->
  <div class="modal" id="editModal">
    <div class="panel">
      <h3>Editar Diezmo</h3>
      <form id="editForm">
        <div style="display:flex;gap:8px;margin-top:8px">
          <input id="editName" required />
          <input id="editAmount" type="number" step="0.01" required />
          <input id="editDate" type="date" />
        </div>
        <div style="margin-top:8px">
          <input id="editNotes" />
        </div>
        <div style="text-align:right;margin-top:10px">
          <button class="btn secondary" type="button" id="cancelEdit">Cancelar</button>
          <button class="btn" type="submit">Guardar</button>
        </div>
      </form>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    const STORAGE_KEY = 'diezmos:v2';
    let diezmos = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
    const listEl = document.getElementById('list');
    const form = document.getElementById('form');
    const fileInput = document.getElementById('fileInput');

    function render(){
      listEl.innerHTML = '';
      let total = 0;
      diezmos.forEach((d, idx) =>{
        total += parseFloat(d.amount||0);
        const div = document.createElement('div');
        div.className = 'item';
        div.innerHTML = `<div><strong>${escapeHtml(d.name)}</strong> <small>${d.date||''}</small><div>${escapeHtml(d.notes||'')}</div></div>`;
        const controls = document.createElement('div');
        controls.className = 'controls';
        const edit = document.createElement('button'); edit.className='btn secondary'; edit.textContent='Editar';
        edit.onclick = ()=>openEdit(idx);
        const del = document.createElement('button'); del.className='btn secondary'; del.textContent='Eliminar';
        del.onclick = ()=>confirmDelete(idx);
        controls.appendChild(edit); controls.appendChild(del);
        div.appendChild(controls);
        listEl.appendChild(div);
      });
      const summary = document.createElement('div'); summary.style.marginTop='12px'; summary.innerHTML = `<strong>Total: ${total.toFixed(2)}</strong>`;
      listEl.appendChild(summary);
    }

    function escapeHtml(s){return String(s||'').replace(/[&<>"']/g, function(c){return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\"':'&#39;'}[c]})}

    form.addEventListener('submit', e=>{
      e.preventDefault();
      const name = document.getElementById('name').value.trim();
      const amount = parseFloat(document.getElementById('amount').value || 0);
      const date = document.getElementById('date').value;
      const notes = document.getElementById('notes').value.trim();
      if(!name || isNaN(amount)) return alert('Nombre y monto son requeridos');
      diezmos.unshift({name,amount,date,notes,created:Date.now()});
      localStorage.setItem(STORAGE_KEY, JSON.stringify(diezmos));
      form.reset(); render();
    });

    // Edit modal
    const editModal = document.getElementById('editModal');
    const editForm = document.getElementById('editForm');
    let editingIndex = null;
    function openEdit(i){
      editingIndex = i;
      const d = diezmos[i];
      document.getElementById('editName').value = d.name;
      document.getElementById('editAmount').value = d.amount;
      document.getElementById('editDate').value = d.date||'';
      document.getElementById('editNotes').value = d.notes||'';
      editModal.style.display='flex';
    }
    document.getElementById('cancelEdit').onclick = ()=>{editModal.style.display='none'; editingIndex=null};
    editForm.addEventListener('submit', e=>{
      e.preventDefault();
      if(editingIndex==null) return;
      const name = document.getElementById('editName').value.trim();
      const amount = parseFloat(document.getElementById('editAmount').value || 0);
      const date = document.getElementById('editDate').value;
      const notes = document.getElementById('editNotes').value.trim();
      if(!name || isNaN(amount)) return alert('Nombre y monto son requeridos');
      diezmos[editingIndex] = {...diezmos[editingIndex], name, amount, date, notes};
      localStorage.setItem(STORAGE_KEY, JSON.stringify(diezmos));
      editModal.style.display='none'; editingIndex=null; render();
    });

    // Confirm delete simple
    function confirmDelete(i){ if(confirm('¿Eliminar este diezmo?')){ diezmos.splice(i,1); localStorage.setItem(STORAGE_KEY, JSON.stringify(diezmos)); render(); } }

    // Export/Import
    document.getElementById('exportBtn').onclick = ()=>{
      const data = JSON.stringify(diezmos, null, 2);
      const blob = new Blob([data], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'diezmos.json'; a.click(); URL.revokeObjectURL(url);
    };
    document.getElementById('importBtn').onclick = ()=> document.getElementById('fileInput').click();
    fileInput.onchange = (e)=>{
      const f = e.target.files[0]; if(!f) return;
      const reader = new FileReader();
      reader.onload = ()=>{
        try{
          const imported = JSON.parse(reader.result);
          if(!Array.isArray(imported)) throw new Error('Formato inválido');
          diezmos = [...imported, ...diezmos];
          localStorage.setItem(STORAGE_KEY, JSON.stringify(diezmos));
          render();
          alert('Importado');
        }catch(err){alert('Error: '+err.message)}
      };
      reader.readAsText(f);
      fileInput.value='';
    };

    // PDF export using jsPDF
    document.getElementById('pdfBtn').onclick = ()=>{
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.setFontSize(12);
      let y=10;
      doc.text('Diezmos', 10, y); y+=8;
      let total = 0;
      diezmos.forEach((d, i)=>{
        const line = `${d.name} - ${Number(d.amount).toFixed(2)} ${d.date?'- '+d.date:''}`;
        doc.text(line, 10, y); y+=6;
        total += parseFloat(d.amount||0);
        if(d.notes){ const split = doc.splitTextToSize(d.notes, 180); doc.text(split, 10, y); y += split.length*6; }
        if(y>280){doc.addPage(); y=10}
      });
      doc.text('Total: ' + total.toFixed(2), 10, y+6);
      doc.save('diezmos.pdf');
    };

    if('serviceWorker' in navigator){ navigator.serviceWorker.register('/sw.js').catch(()=>{}); }

    render();
  </script>
</body>
</html>
