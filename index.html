<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Multi Servicios LARA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lucide/0.263.0/lucide.min.js"></script>
    <!-- localForage para usar IndexedDB (m√°s robusto que localStorage) -->
    <script src="https://cdn.jsdelivr.net/npm/localforage@1.10.0/dist/localforage.min.js"></script>
    <style>
        /* Estilos Base y Variables */
        :root { 
            --primary: #3b82f6; /* Blue 500 */
            --bg: #0f172a; /* Slate 900 */
            --card-bg: #1e293b; /* Slate 800 */
            --text-color: #f1f5f9; /* Slate 100 */
        }
        body { background-color: var(--bg); color: var(--text-color); font-family: 'Segoe UI', sans-serif; margin:0; }
        
        /* Estilo Glass mejorado */
        .glass { 
            background: rgba(30, 41, 59, 0.8); 
            backdrop-filter: blur(12px); 
            border: 1px solid rgba(255,255,255,0.1); 
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }
        
        /* Estilo de Inputs y Selects */
        input, select, textarea { 
            background: var(--card-bg) !important; 
            border: 1px solid #334155 !important; 
            color: var(--text-color) !important; 
            padding: 0.8rem; 
            border-radius: 0.6rem; 
            width: 100%; 
            font-size: 16px; 
            margin-bottom: 8px; 
            transition: border-color 0.2s;
        }
        input:focus, select:focus, textarea:focus {
            border-color: var(--primary) !important;
            outline: none;
        }

        /* Estilo de Bot√≥n Principal */
        .btn-blue { 
            background: #2563eb; 
            color: white; 
            font-weight: bold; 
            padding: 1rem; 
            border-radius: 0.6rem; 
            width: 100%; 
            transition: 0.2s; 
            border: none; 
            cursor: pointer; 
        }
        .btn-blue:active { background: #1d4ed8; transform: scale(0.98); }

        /* Estilo de Navegaci√≥n (Ajuste Final UI/UX) */
        .nav-bar {
            background: var(--card-bg);
            border-top: 1px solid #334155;
            box-shadow: 0 -4px 10px rgba(0, 0, 0, 0.2);
            padding: 4px; 
        }
        .nav-btn { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            font-size: 0.65rem; 
            color: #94a3b8; 
            flex: 1; 
            padding: 8px 0; 
            border:none; 
            background:none; 
            transition: color 0.2s, transform 0.1s, background 0.2s;
            border-radius: 8px; 
            margin: 0 4px;
        }
        .nav-btn:hover { background: rgba(255, 255, 255, 0.05); }
        .nav-btn:active { transform: scale(0.95); }
        .nav-active { 
            color: var(--primary); 
            font-weight: bold;
            background: rgba(59, 130, 246, 0.15); 
        }
        .nav-btn i { margin-bottom: 2px; }

        /* Estilos de Tarjeta (Card) - Nuevo Estilo */
        .card {
            background: var(--card-bg);
            border-radius: 1rem;
            padding: 1rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 1rem;
            transition: background 0.2s;
        }
        .card.selected {
            background: rgba(59, 130, 246, 0.3); /* Fondo azul para selecci√≥n */
        }

        /* Estilo para la Notificaci√≥n Sutil */
        #notification {
            position: fixed;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            background-color: #10b981; /* Emerald 500 */
            color: white;
            padding: 10px 20px;
            border-radius: 0 0 8px 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            font-weight: bold;
        }
        #notification.show {
            opacity: 1;
        }

        /* Bot√≥n Flotante de Edici√≥n */
        .fab {
            position: fixed;
            bottom: 80px;
            right: 20px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background-color: #ef4444; /* Rojo para Borrar */
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
            z-index: 900;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.2s;
        }
        .fab:active { transform: scale(0.95); }
        .fab.active { background-color: #10b981; } /* Verde para Salir del modo */
    </style>
</head>
<body class="pb-24">

    <!-- NOTIFICACI√ìN SUTIL -->
    <div id="notification"></div>

    <!-- PANTALLA DE BIENVENIDA PERSONALIZADA -->
    <div id="welcome" class="fixed inset-0 z-50 bg-[#0f172a] flex flex-col items-center justify-center p-6 text-center">
        <div class="w-32 h-32 bg-white p-4 rounded-3xl mb-6 shadow-2xl">
            <img src="aa.jpg" alt="Logo" class="w-full h-full object-contain">
        </div>
        <h1 class="text-3xl font-black mb-1 uppercase text-blue-400">MULTI SERVICIOS LARA</h1>
        <p class="text-slate-400 text-lg mb-1">Servicio de Transporte Privado</p>
        <p class="text-blue-300 font-semibold mb-10 italic">"Moviendo Vidas"</p>
        <button onclick="document.getElementById('welcome').style.display='none'" class="btn-blue w-full max-w-xs">ENTRAR</button>
    </div>

    <header class="p-4 flex justify-between items-center glass sticky top-0 z-30">
        <span id="section-title" class="font-bold text-blue-400 uppercase tracking-tighter text-sm">REGISTROS</span>
        <img src="aa.jpg" class="h-8 w-8 rounded-lg object-cover bg-white">
    </header>

    <main class="p-4 max-w-md mx-auto">
        <!-- SECCI√ìN REGISTROS -->
        <section id="sec-registros" class="space-y-4">
            <div class="card">
                <label class="text-[10px] font-bold text-slate-500 uppercase">Fecha</label>
                <input type="date" id="reg-fecha">
                
                <label class="text-[10px] font-bold text-slate-500 uppercase">Tipo de Flujo</label>
                <select id="reg-tipo-flujo">
                    <option value="Ingreso">üü¢ Ingreso</option>
                    <option value="Gasto">üî¥ Gasto</option>
                </select>
                
                <label class="text-[10px] font-bold text-slate-500 uppercase">Categor√≠a</label>
                <select id="reg-categoria">
                    <option value="Uber Diario">üöï Uber Diario</option>
                    <option value="Renta Carro">üîë Renta Carro</option>
                    <option value="Mantenimiento">üõ†Ô∏è Mantenimiento</option>
                    <option value="Internet">üåê Internet</option>
                    <option value="Gasolina">‚õΩ Gasolina</option>
                    <option value="Privado">üë§ Privado</option>
                    <option value="Otros">üì¶ Otros</option>
                </select>
                
                <label class="text-[10px] font-bold text-slate-500 uppercase">Monto (Q)</label>
                <input type="number" id="reg-monto" placeholder="0.00" inputmode="decimal">
                
                <textarea id="reg-concepto" placeholder="Notas adicionales..."></textarea>
                
                <button type="button" onclick="saveRegistro()" class="btn-blue mt-2">GUARDAR REGISTRO</button>
            </div>
            <!-- FILTRO DE FECHA -->
            <div class="card">
                <label class="text-[10px] font-bold text-slate-500 uppercase">Filtrar por Fecha</label>
                <input type="date" id="reg-filtro-fecha" onchange="renderRegistrosList()">
            </div>
            <!-- VISTA DE REGISTROS -->
            <div id="registros-list" class="space-y-3">
                <div class="p-4 text-center text-slate-400">Cargando registros...</div>
            </div>
        </section>

        <!-- SECCI√ìN VIAJES -->
        <section id="sec-viajes" class="hidden space-y-4">
            <div class="card">
                <input type="text" id="v-cliente" placeholder="Cliente">
                <input type="text" id="v-inicio" placeholder="Origen">
                <input type="text" id="v-fin" placeholder="Destino">
                <input type="number" id="v-costo" placeholder="Costo Q">
                <input type="date" id="v-fecha">
                <select id="v-tipo">
                    <option value="Cotizaci√≥n">üìÑ Cotizaci√≥n</option>
                    <option value="Agendado">üìÖ Agendado</option>
                    <option value="Realizado">‚úÖ Realizado</option>
                </select>
                <button type="button" onclick="saveViaje()" class="btn-blue">GUARDAR VIAJE</button>
            </div>
            <!-- VISTA DE VIAJES -->
            <div id="viajes-list" class="space-y-3">
                <div class="p-4 text-center text-slate-400">Cargando viajes...</div>
            </div>
        </section>

        <!-- SECCI√ìN DIEZMOS -->
        <section id="sec-diezmos" class="hidden space-y-4">
            <div id="diezmo-info" class="card bg-blue-900/20 border-blue-500/30"></div>
            <div class="card">
                <!-- CAMPO TIPO DE PAGO -->
                <label class="text-[10px] font-bold text-slate-500 uppercase">Tipo de Pago</label>
                <select id="d-tipo-pago">
                    <option value="Efectivo">üíµ Efectivo</option>
                    <option value="Transferencia">üí≥ Transferencia</option>
                </select>
                
                <input type="number" id="d-pago" placeholder="Monto a pagar Q">
                <button type="button" onclick="saveDiezmo()" class="w-full bg-emerald-600 py-4 rounded-xl font-bold">REGISTRAR PAGO</button>
            </div>
            <!-- VISTA DE PAGOS DE DIEZMO -->
            <div id="diezmo-pagos-list" class="space-y-3">
                <div class="p-4 text-center text-slate-400">Cargando historial de pagos...</div>
            </div>
        </section>

        <!-- SECCI√ìN RESUMEN DETALLADO -->
        <section id="sec-resumen" class="hidden space-y-4">
            <div id="resumen-container"></div>
            <div id="resumen-categorias" class="card mb-4"></div>
            <div id="resumen-historial" class="card mb-4"></div>
            <!-- VISTAS DE INGRESOS Y GASTOS -->
            <div id="resumen-ingresos-gastos" class="space-y-4"></div>
            <button onclick="borrarDatos()" class="w-full text-red-500 text-[10px] opacity-30 mt-10">BORRAR TODOS LOS DATOS</button>
        </section>
    </main>

    <!-- BARRA DE NAVEGACI√ìN MEJORADA -->
    <nav class="fixed bottom-0 left-0 right-0 nav-bar flex p-1 z-40">
        <button onclick="nav('registros')" id="n-registros" class="nav-btn nav-active"><i data-lucide="pen-tool"></i>Registros</button>
        <button onclick="nav('viajes')" id="n-viajes" class="nav-btn"><i data-lucide="car"></i>Viajes</button>
        <button onclick="nav('diezmos')" id="n-diezmos" class="nav-btn"><i data-lucide="heart"></i>Diezmos</button>
        <button onclick="nav('resumen')" id="n-resumen" class="nav-btn"><i data-lucide="bar-chart-3"></i>Resumen</button>
    </nav>

    <!-- BOT√ìN FLOTANTE DE EDICI√ìN/BORRADO -->
    <div id="fab-edit" class="fab hidden" onclick="toggleEditMode()">
        <i id="fab-icon" data-lucide="trash-2" class="w-6 h-6"></i>
    </div>

    <script>
        // Variable global para la base de datos.
        let db = { registros: [], viajes: [], diezmos: [] };
        let editMode = false;
        let selectedItems = [];
        let currentSection = 'registros';
        
        // CAMBIO DE MONEDA: Quetzales (Q)
        const formatter = new Intl.NumberFormat('es-GT', { 
            style: 'currency', 
            currency: 'GTQ',
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });

        // --- FUNCIONES AUXILIARES ---

        function showNotification(message) {
            const notif = document.getElementById('notification');
            notif.innerText = message;
            notif.classList.add('show');
            setTimeout(() => {
                notif.classList.remove('show');
            }, 2000);
        }

        function normalizeDate(dateString) {
            const date = new Date(dateString);
            return new Date(date.getFullYear(), date.getMonth(), date.getDate());
        }

        function formatDate(dateString) {
            const date = new Date(dateString + 'T00:00:00'); // Evitar problemas de zona horaria
            return date.toLocaleDateString('es-MX', { day: '2-digit', month: 'short', year: 'numeric' });
        }

        function getQuincenaRange(date) {
            const day = date.getDate();
            let start, end;

            if (day <= 15) {
                start = new Date(date.getFullYear(), date.getMonth(), 1);
                end = new Date(date.getFullYear(), date.getMonth(), 15);
            } else {
                start = new Date(date.getFullYear(), date.getMonth(), 16);
                end = new Date(date.getFullYear(), date.getMonth() + 1, 0); // √öltimo d√≠a del mes
            }
            
            // Normalizar a 00:00:00 y 23:59:59.999
            start.setHours(0, 0, 0, 0);
            end.setHours(23, 59, 59, 999);

            return { start, end };
        }

        function getNetoForRange(startDate, endDate) {
            let ing = 0, gas = 0;
            
            if (db.registros) {
                db.registros.forEach(r => {
                    const f = normalizeDate(r.fecha); 
                    
                    if(f >= startDate && f <= endDate) {
                        if(r.flujo === 'Ingreso') ing += r.monto; else gas += r.monto;
                    }
                });
            }
            return { ing, gas, neto: ing - gas };
        }

        // --- FUNCIONES DE BASE DE DATOS (localForage) ---

        async function saveDB() { 
            try {
                await localforage.setItem('lara_final_db', db);
            } catch (err) {
                console.error("Error al guardar en IndexedDB:", err);
                showNotification("‚ùå Error al guardar los datos.");
            }
        }

        // --- FUNCIONES DE NAVEGACI√ìN Y VISTAS ---

        function nav(s) {
            currentSection = s;
            ['registros', 'viajes', 'diezmos', 'resumen'].forEach(sec => {
                document.getElementById('sec-'+sec).classList.add('hidden');
                document.getElementById('n-'+sec).classList.remove('nav-active');
            });
            document.getElementById('sec-'+s).classList.remove('hidden');
            document.getElementById('n-'+s).classList.add('nav-active');
            document.getElementById('section-title').innerText = s.toUpperCase();
            
            // Mostrar/Ocultar FAB
            const fab = document.getElementById('fab-edit');
            if (s === 'registros' || s === 'viajes' || s === 'diezmos') {
                fab.classList.remove('hidden');
            } else {
                fab.classList.add('hidden');
            }

            // Renderizar la vista y salir del modo edici√≥n
            editMode = false;
            selectedItems = [];
            fab.classList.remove('active');
            document.getElementById('fab-icon').setAttribute('data-lucide', 'trash-2');
            
            if(s === 'registros') renderRegistrosList();
            else if(s === 'viajes') renderViajesList();
            else if(s === 'resumen') updateResumen();
            else if(s === 'diezmos') updateDiezmosView();
            lucide.createIcons();
        }

        // --- MODO EDICI√ìN/BORRADO ---

        function toggleEditMode() {
            if (!editMode) {
                // Entrar en modo edici√≥n
                editMode = true;
                selectedItems = [];
                document.getElementById('fab-edit').classList.add('active');
                document.getElementById('fab-icon').setAttribute('data-lucide', 'x');
                showNotification("Modo Borrado Activado. Selecciona elementos.");
            } else {
                // Salir o Borrar
                if (selectedItems.length > 0) {
                    if (confirm(`¬øEst√°s seguro de que quieres borrar ${selectedItems.length} elementos?`)) {
                        deleteSelectedItems();
                    }
                }
                
                // Salir del modo edici√≥n
                editMode = false;
                selectedItems = [];
                document.getElementById('fab-edit').classList.remove('active');
                document.getElementById('fab-icon').setAttribute('data-lucide', 'trash-2');
                showNotification("Modo Borrado Desactivado.");
            }
            
            // Re-renderizar la lista para mostrar/ocultar checkboxes
            if (currentSection === 'registros') renderRegistrosList();
            else if (currentSection === 'viajes') renderViajesList();
            else if (currentSection === 'diezmos') updateDiezmosView();
        }

        function selectItem(index, element) {
            const id = `${currentSection}-${index}`;
            const existingIndex = selectedItems.indexOf(id);

            if (existingIndex === -1) {
                selectedItems.push(id);
                element.classList.add('selected');
            } else {
                selectedItems.splice(existingIndex, 1);
                element.classList.remove('selected');
            }
            
            // Actualizar el icono del FAB para reflejar si hay elementos seleccionados
            const fab = document.getElementById('fab-edit');
            if (selectedItems.length > 0) {
                fab.style.backgroundColor = '#ef4444'; // Rojo para borrar
                document.getElementById('fab-icon').setAttribute('data-lucide', 'trash-2');
            } else {
                fab.style.backgroundColor = '#10b981'; // Verde para salir
                document.getElementById('fab-icon').setAttribute('data-lucide', 'x');
            }
            lucide.createIcons();
        }

        async function deleteSelectedItems() {
            // Obtener los √≠ndices originales a borrar
            const indicesToDelete = selectedItems
                .filter(id => id.startsWith(currentSection))
                .map(id => parseInt(id.split('-')[1]))
                .sort((a, b) => b - a); // Ordenar descendente para borrar sin afectar √≠ndices

            if (indicesToDelete.length === 0) return;

            // Borrar de la base de datos
            indicesToDelete.forEach(index => {
                db[currentSection].splice(index, 1);
            });

            await saveDB();
            showNotification(`üóëÔ∏è ${indicesToDelete.length} elementos borrados.`);
            
            // Re-renderizar la vista
            if (currentSection === 'registros') renderRegistrosList();
            else if (currentSection === 'viajes') renderViajesList();
            else if (currentSection === 'diezmos') updateDiezmosView();
            
            // Actualizar resumen si es necesario
            if (document.getElementById('sec-resumen').classList.contains('hidden') === false) {
                updateResumen();
            }
        }

        // --- VISTAS DETALLADAS ---

        function renderRegistrosList() {
            const container = document.getElementById('registros-list');
            const filtroFecha = document.getElementById('reg-filtro-fecha').value;
            
            if (!db.registros || db.registros.length === 0) {
                container.innerHTML = '<div class="p-4 text-center text-slate-400">No hay registros guardados.</div>';
                return;
            }

            // 1. Filtrar y mapear con √≠ndice original
            let filteredRegistros = db.registros.map((r, index) => ({...r, originalIndex: index}));
            if (filtroFecha) {
                filteredRegistros = filteredRegistros.filter(r => r.fecha === filtroFecha);
            }

            if (filteredRegistros.length === 0) {
                container.innerHTML = '<div class="p-4 text-center text-slate-400">No hay registros para la fecha seleccionada.</div>';
                return;
            }

            // 2. Ordenar: M√°s reciente primero (descendente)
            const sortedRegistros = filteredRegistros.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));

            let html = '';
            sortedRegistros.forEach((r) => {
                const isIngreso = r.flujo === 'Ingreso';
                const color = isIngreso ? 'text-emerald-400' : 'text-red-400';
                const sign = isIngreso ? '+' : '-';
                const isSelected = selectedItems.includes(`registros-${r.originalIndex}`) ? 'selected' : '';
                
                html += `
                    <div class="card flex items-center ${isSelected}" onclick="if(editMode) selectItem(${r.originalIndex}, this)">
                        ${editMode ? `<input type="checkbox" class="mr-3 w-5 h-5" ${isSelected ? 'checked' : ''} onclick="event.stopPropagation(); selectItem(${r.originalIndex}, this.parentNode)">` : ''}
                        <div class="flex-1">
                            <p class="text-sm font-bold ${color}">${r.cat} (${r.flujo})</p>
                            <p class="text-xs text-slate-400">${formatDate(r.fecha)}</p>
                            <p class="text-xs text-slate-500">${r.concepto || 'Sin notas'}</p>
                        </div>
                        <div class="text-right">
                            <p class="text-lg font-black ${color}">${sign}${formatter.format(r.monto).replace('GTQ', 'Q')}</p>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
            lucide.createIcons(); 
        }

        function renderViajesList() {
            const container = document.getElementById('viajes-list');
            if (!db.viajes || db.viajes.length === 0) {
                container.innerHTML = '<div class="p-4 text-center text-slate-400">No hay viajes guardados.</div>';
                return;
            }

            // 1. Mapear con √≠ndice original
            const viajesWithIndex = db.viajes.map((v, index) => ({...v, originalIndex: index}));

            // 2. Ordenar: M√°s reciente primero (descendente)
            const sortedViajes = viajesWithIndex.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));

            let html = '';
            sortedViajes.forEach((v) => {
                const color = v.tipo === 'Realizado' ? 'text-emerald-400' : 'text-blue-400';
                const isSelected = selectedItems.includes(`viajes-${v.originalIndex}`) ? 'selected' : '';

                html += `
                    <div class="card flex items-center ${isSelected}" onclick="if(editMode) selectItem(${v.originalIndex}, this)">
                        ${editMode ? `<input type="checkbox" class="mr-3 w-5 h-5" ${isSelected ? 'checked' : ''} onclick="event.stopPropagation(); selectItem(${v.originalIndex}, this.parentNode)">` : ''}
                        <div class="flex-1">
                            <p class="text-sm font-bold">${v.cliente}</p>
                            <p class="text-xs text-slate-400">${formatDate(v.fecha)} - ${v.tipo}</p>
                            <p class="text-xs text-slate-500">${v.inicio} a ${v.fin}</p>
                        </div>
                        <div class="text-right">
                            <p class="text-lg font-black ${color}">${formatter.format(v.costo).replace('GTQ', 'Q')}</p>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
            lucide.createIcons(); 
        }

        // --- FUNCIONES DE GUARDADO ---

        async function saveRegistro() {
            const monto = parseFloat(document.getElementById('reg-monto').value);
            
            if(isNaN(monto)) { 
                showNotification("‚ùå Ingresa un monto v√°lido."); 
                return; 
            }
            
            if (!db.registros) {
                db.registros = [];
            }

            db.registros.push({
                fecha: document.getElementById('reg-fecha').value,
                flujo: document.getElementById('reg-tipo-flujo').value,
                cat: document.getElementById('reg-categoria').value,
                monto: monto,
                concepto: document.getElementById('reg-concepto').value
            });
            
            await saveDB();
            showNotification("‚úÖ Registro guardado.");
            document.getElementById('reg-monto').value = '';
            document.getElementById('reg-concepto').value = '';
            renderRegistrosList(); 
        }

        async function saveViaje() {
            const costo = parseFloat(document.getElementById('v-costo').value);
            if(isNaN(costo)) { 
                showNotification("‚ùå Ingresa un costo v√°lido."); 
                return; 
            }

            if (!db.viajes) {
                db.viajes = [];
            }

            db.viajes.push({
                cliente: document.getElementById('v-cliente').value,
                inicio: document.getElementById('v-inicio').value,
                fin: document.getElementById('v-fin').value,
                costo: costo,
                fecha: document.getElementById('v-fecha').value,
                tipo: document.getElementById('v-tipo').value
            });
            await saveDB(); 
            showNotification("‚úÖ Viaje guardado.");
            // Limpiar campos despu√©s de guardar
            document.getElementById('v-cliente').value = '';
            document.getElementById('v-inicio').value = '';
            document.getElementById('v-fin').value = '';
            document.getElementById('v-costo').value = '';
            renderViajesList(); 
        }

        async function saveDiezmo() {
            const m = parseFloat(document.getElementById('d-pago').value);
            const tipoPago = document.getElementById('d-tipo-pago').value; 
            
            if(isNaN(m) || m <= 0) {
                showNotification("‚ùå Ingresa un monto de pago v√°lido.");
                return;
            }

            if (!db.diezmos) {
                db.diezmos = [];
            }

            db.diezmos.push({ 
                monto: m, 
                fecha: new Date().toISOString().split('T')[0],
                tipo: tipoPago
            }); 
            await saveDB(); 
            updateDiezmosView();
            document.getElementById('d-pago').value = '';
            showNotification("üôè Diezmo registrado.");
        }

        // --- FUNCIONES DE RESUMEN Y DIEZMOS ---

        function renderMonthlyDetails() {
            const container = document.getElementById('resumen-ingresos-gastos');
            const hoy = new Date();
            const startOfMonth = new Date(hoy.getFullYear(), hoy.getMonth(), 1);
            const endOfMonth = new Date(hoy.getFullYear(), hoy.getMonth() + 1, 0);
            endOfMonth.setHours(23, 59, 59, 999);

            const registrosMes = db.registros.filter(r => {
                const f = normalizeDate(r.fecha);
                return f >= startOfMonth && f <= endOfMonth;
            }).sort((a, b) => new Date(b.fecha) - new Date(a.fecha)); 

            const ingresos = registrosMes.filter(r => r.flujo === 'Ingreso');
            const gastos = registrosMes.filter(r => r.flujo === 'Gasto');

            let html = `
                <h3 class="text-sm font-bold text-emerald-400 mb-3 uppercase">Ingresos del Mes (${hoy.toLocaleDateString('es-MX', { month: 'long', year: 'numeric' })})</h3>
                <div class="space-y-3">
            `;
            if (ingresos.length === 0) {
                html += '<div class="card text-center text-slate-400">No hay ingresos este mes.</div>';
            } else {
                ingresos.forEach(r => {
                    html += `
                        <div class="card flex justify-between items-center">
                            <div class="flex-1">
                                <p class="text-sm font-bold">${r.cat}</p>
                                <p class="text-xs text-slate-400">${formatDate(r.fecha)}</p>
                            </div>
                            <div class="text-right">
                                <p class="text-lg font-black text-emerald-400">+${formatter.format(r.monto).replace('GTQ', 'Q')}</p>
                            </div>
                        </div>
                    `;
                });
            }
            html += '</div>';

            html += `
                <h3 class="text-sm font-bold text-red-400 mb-3 uppercase mt-6">Gastos del Mes (${hoy.toLocaleDateString('es-MX', { month: 'long', year: 'numeric' })})</h3>
                <div class="space-y-3">
            `;
            if (gastos.length === 0) {
                html += '<div class="card text-center text-slate-400">No hay gastos este mes.</div>';
            } else {
                gastos.forEach(r => {
                    html += `
                        <div class="card flex justify-between items-center">
                            <div class="flex-1">
                                <p class="text-sm font-bold">${r.cat}</p>
                                <p class="text-xs text-slate-400">${formatDate(r.fecha)}</p>
                            </div>
                            <div class="text-right">
                                <p class="text-lg font-black text-red-400">-${formatter.format(r.monto).replace('GTQ', 'Q')}</p>
                            </div>
                        </div>
                    `;
                });
            }
            html += '</div>';

            container.innerHTML = html;
        }

        function updateResumen() {
            // 1. Resumen Semanal (Mantenido)
            const hoy = new Date();
            const day = hoy.getDay() || 7; 
            const lunes = new Date(hoy); lunes.setDate(hoy.getDate() - day + 1); lunes.setHours(0,0,0,0);
            const dom = new Date(lunes); dom.setDate(lunes.getDate() + 6); dom.setHours(23,59,59,999);

            const { ing: ingSemanal, gas: gasSemanal, neto: netoSemanal } = getNetoForRange(lunes, dom);

            document.getElementById('resumen-container').innerHTML = `
                <div class="card p-6 text-center border-b-4 border-blue-500 mb-4">
                    <p class="text-slate-400 text-[10px] uppercase">Ganancia Neta Semanal</p>
                    <h4 class="text-4xl font-black text-blue-400 my-2">${formatter.format(netoSemanal).replace('GTQ', 'Q')}</h4>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div class="card p-4 text-center"><p class="text-[10px] text-slate-400">INGRESOS</p><p class="text-lg font-bold text-emerald-400">${formatter.format(ingSemanal).replace('GTQ', 'Q')}</p></div>
                    <div class="card p-4 text-center"><p class="text-[10px] text-slate-400">GASTOS</p><p class="text-lg font-bold text-red-400">${formatter.format(gasSemanal).replace('GTQ', 'Q')}</p></div>
                </div>`;

            // 2. Resumen por Categor√≠as
            const categorias = {};
            if (db.registros) {
                db.registros.forEach(r => {
                    if (!categorias[r.cat]) {
                        categorias[r.cat] = { Ingreso: 0, Gasto: 0 };
                    }
                    categorias[r.cat][r.flujo] += r.monto;
                });
            }

            let catHtml = '<h3 class="text-sm font-bold text-blue-400 mb-3 uppercase">Desglose por Categor√≠a</h3>';
            for (const cat in categorias) {
                const ing = categorias[cat].Ingreso;
                const gas = categorias[cat].Gasto;
                const neto = ing - gas;
                const color = neto >= 0 ? 'text-emerald-400' : 'text-red-400';

                catHtml += `
                    <div class="flex justify-between items-center py-2 border-b border-white/10 last:border-b-0">
                        <div class="flex-1">
                            <p class="text-sm font-bold">${cat}</p>
                            <p class="text-xs text-slate-400">Ingresos: ${formatter.format(ing).replace('GTQ', 'Q')} / Gastos: ${formatter.format(gas).replace('GTQ', 'Q')}</p>
                        </div>
                        <div class="text-right">
                            <p class="text-lg font-black ${color}">${formatter.format(neto).replace('GTQ', 'Q')}</p>
                        </div>
                    </div>
                `;
            }
            document.getElementById('resumen-categorias').innerHTML = catHtml;

            // 3. Historial Mensual
            const historial = {};
            if (db.registros) {
                db.registros.forEach(r => {
                    const [year, month] = r.fecha.split('-');
                    const key = `${year}-${month}`;
                    if (!historial[key]) {
                        historial[key] = { Ingreso: 0, Gasto: 0 };
                    }
                    historial[key][r.flujo] += r.monto;
                });
            }

            let histHtml = '<h3 class="text-sm font-bold text-blue-400 mb-3 uppercase">Historial Mensual</h3>';
            const sortedMonths = Object.keys(historial).sort().reverse();
            let totalNetoGlobal = 0;

            sortedMonths.forEach(key => {
                const [year, month] = key.split('-');
                const monthName = new Date(year, month - 1).toLocaleDateString('es-MX', { month: 'long', year: 'numeric' });
                const ing = historial[key].Ingreso;
                const gas = historial[key].Gasto;
                const neto = ing - gas;
                totalNetoGlobal += neto;
                const color = neto >= 0 ? 'text-emerald-400' : 'text-red-400';

                histHtml += `
                    <div class="flex justify-between items-center py-2 border-b border-white/10 last:border-b-0">
                        <div class="flex-1">
                            <p class="text-sm font-bold">${monthName.charAt(0).toUpperCase() + monthName.slice(1)}</p>
                            <p class="text-xs text-slate-400">Ingresos: ${formatter.format(ing).replace('GTQ', 'Q')} / Gastos: ${formatter.format(gas).replace('GTQ', 'Q')}</p>
                        </div>
                        <div class="text-right">
                            <p class="text-lg font-black ${color}">${formatter.format(neto).replace('GTQ', 'Q')}</p>
                        </div>
                    </div>
                `;
            });

            histHtml = `
                <div class="text-center p-4">
                    <p class="text-slate-400 text-[10px] uppercase">Ganancia Neta Total</p>
                    <h4 class="text-3xl font-black ${totalNetoGlobal >= 0 ? 'text-emerald-400' : 'text-red-400'}">${formatter.format(totalNetoGlobal).replace('GTQ', 'Q')}</h4>
                </div>
                ${histHtml}
            `;
            document.getElementById('resumen-historial').innerHTML = histHtml;

            // 4. Vistas de Ingresos y Gastos del Mes
            renderMonthlyDetails();
        }

        function updateDiezmosView() {
            const hoy = new Date();
            const { start: qStart, end: qEnd } = getQuincenaRange(hoy);
            const { neto: netoQuincenal } = getNetoForRange(qStart, qEnd);
            
            const diezmoSugerido = netoQuincenal > 0 ? netoQuincenal * 0.10 : 0;
            
            let pagadoQuincenal = 0;
            if (db.diezmos) {
                db.diezmos.forEach(d => {
                    const f = normalizeDate(d.fecha);
                    if (f >= qStart && f <= qEnd) {
                        pagadoQuincenal += d.monto;
                    }
                });
            }

            const faltante = Math.max(0, diezmoSugerido - pagadoQuincenal);

            // Mostrar el resumen de la quincena actual
            document.getElementById('diezmo-info').innerHTML = `
                <h3 class="text-sm font-bold text-blue-400 mb-3 uppercase">Quincena Actual: ${qStart.getDate()} - ${qEnd.getDate()} de ${qStart.toLocaleDateString('es-MX', { month: 'long' })}</h3>
                <div class="space-y-2 text-sm">
                    <div class="flex justify-between"><span>Neta Quincenal:</span><b>${formatter.format(netoQuincenal).replace('GTQ', 'Q')}</b></div>
                    <div class="flex justify-between text-blue-400"><span>Diezmo Sugerido (10%):</span><b>${formatter.format(diezmoSugerido).replace('GTQ', 'Q')}</b></div>
                    <div class="flex justify-between text-emerald-400 border-t border-white/10 pt-2"><span>Pagado en Quincena:</span><b>${formatter.format(pagadoQuincenal).replace('GTQ', 'Q')}</b></div>
                    <div class="flex justify-between text-red-400 font-black text-lg"><span>FALTANTE:</span><span>${formatter.format(faltante).replace('GTQ', 'Q')}</span></div>
                </div>`;

            // Historial de Pagos de Diezmo
            const pagosContainer = document.getElementById('diezmo-pagos-list');
            if (!db.diezmos || db.diezmos.length === 0) {
                pagosContainer.innerHTML = '<div class="card text-center text-slate-400">No hay pagos de diezmo registrados.</div>';
                return;
            }

            // Agrupar pagos por quincena
            const historialDiezmos = {};
            db.diezmos.forEach((d, index) => {
                const date = new Date(d.fecha);
                const { start } = getQuincenaRange(date);
                const key = start.toISOString().split('T')[0]; // Usar la fecha de inicio como clave
                if (!historialDiezmos[key]) {
                    historialDiezmos[key] = { pagos: 0, fechaInicio: start, pagosDetalle: [] };
                }
                historialDiezmos[key].pagos += d.monto;
                historialDiezmos[key].pagosDetalle.push({ monto: d.monto, fecha: d.fecha, tipo: d.tipo, originalIndex: index });
            });

            let pagosHtml = '<h3 class="text-sm font-bold text-blue-400 mb-3 uppercase">Historial de Pagos</h3>';
            // Ordenar quincenas: M√°s reciente primero (descendente)
            const sortedQuincenas = Object.keys(historialDiezmos).sort().reverse();

            sortedQuincenas.forEach(key => {
                const { pagos, fechaInicio, pagosDetalle } = historialDiezmos[key];
                const { end: fechaFin } = getQuincenaRange(fechaInicio);
                const { neto } = getNetoForRange(fechaInicio, fechaFin);
                const diezmoSug = neto > 0 ? neto * 0.10 : 0;
                const balance = diezmoSug - pagos;
                const color = balance <= 0 ? 'text-emerald-400' : 'text-red-400';
                const status = balance <= 0 ? '‚úÖ Pagado' : '‚ùå Pendiente';

                pagosHtml += `
                    <div class="card flex-col items-start">
                        <div class="w-full flex justify-between items-center pb-2 border-b border-white/10">
                            <div class="flex-1">
                                <p class="text-sm font-bold">Quincena: ${fechaInicio.getDate()} - ${fechaFin.getDate()} ${fechaInicio.toLocaleDateString('es-MX', { month: 'short', year: 'numeric' })}</p>
                                <p class="text-xs text-slate-400">Neta: ${formatter.format(neto).replace('GTQ', 'Q')} | Sugerido: ${formatter.format(diezmoSug).replace('GTQ', 'Q')}</p>
                            </div>
                            <div class="text-right">
                                <p class="text-lg font-black ${color}">${formatter.format(balance).replace('GTQ', 'Q')}</p>
                                <p class="text-xs ${color}">${status}</p>
                            </div>
                        </div>
                        <div class="w-full pt-2">
                            <p class="text-xs font-bold text-slate-500 mb-1">Pagos Realizados (${formatter.format(pagos).replace('GTQ', 'Q')}):</p>
                            ${pagosDetalle.map(p => {
                                const isSelected = selectedItems.includes(`diezmos-${p.originalIndex}`) ? 'selected' : '';
                                return `
                                <div class="flex justify-between items-center text-xs pl-2 py-1 ${isSelected}" onclick="if(editMode) selectItem(${p.originalIndex}, this)">
                                    ${editMode ? `<input type="checkbox" class="mr-3 w-4 h-4" ${isSelected ? 'checked' : ''} onclick="event.stopPropagation(); selectItem(${p.originalIndex}, this.parentNode)">` : ''}
                                    <span>${formatDate(p.fecha)} (${p.tipo})</span>
                                    <span class="text-emerald-400 font-bold">${formatter.format(p.monto).replace('GTQ', 'Q')}</span>
                                </div>
                            `;}).join('')}
                        </div>
                    </div>
                `;
            });

            pagosContainer.innerHTML = pagosHtml;
            lucide.createIcons(); 
        }

        async function borrarDatos() { 
            if(confirm("¬øSeguro que quieres borrar todos los datos? Esta acci√≥n es irreversible.")) { 
                try {
                    await localforage.clear();
                    location.reload(); 
                } catch (err) {
                    console.error("Error al borrar datos:", err);
                    showNotification("‚ùå Error al borrar los datos.");
                }
            } 
        }

        // --- INICIALIZACI√ìN ---

        async function initApp() {
            // 1. Cargar la base de datos de IndexedDB
            try {
                const loadedDb = await localforage.getItem('lara_final_db');
                if (loadedDb) {
                    db = loadedDb;
                }
            } catch (err) {
                console.error("Error al cargar la base de datos:", err);
            }

            // 2. Inicializar iconos y fechas
            lucide.createIcons();
            document.getElementById('reg-fecha').valueAsDate = new Date();
            document.getElementById('v-fecha').valueAsDate = new Date();

            // 3. Ejecutar la navegaci√≥n inicial (que mostrar√° la secci√≥n de registros y su lista)
            nav('registros');
        }

        // Iniciar la aplicaci√≥n
        initApp();
    </script>
</body>
</html>
