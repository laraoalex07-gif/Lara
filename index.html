<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Multi Servicios LARA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lucide/0.263.0/lucide.min.js"></script>
    <!-- localForage para usar IndexedDB (m√°s robusto que localStorage) -->
    <script src="https://cdn.jsdelivr.net/npm/localforage@1.10.0/dist/localforage.min.js"></script>
    <style>
        /* Estilos Base y Variables */
        :root { 
            --primary: #3b82f6; /* Blue 500 */
            --bg: #0f172a; /* Slate 900 */
            --card-bg: #1e293b; /* Slate 800 */
            --text-color: #f1f5f9; /* Slate 100 */
        }
        body { background-color: var(--bg); color: var(--text-color); font-family: 'Segoe UI', sans-serif; margin:0; }
        
        /* Estilo Glass mejorado */
        .glass { 
            background: rgba(30, 41, 59, 0.8); 
            backdrop-filter: blur(12px); 
            border: 1px solid rgba(255,255,255,0.1); 
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }
        
        /* Estilo de Inputs y Selects */
        input, select, textarea { 
            background: var(--card-bg) !important; 
            border: 1px solid #334155 !important; 
            color: var(--text-color) !important; 
            padding: 0.8rem; 
            border-radius: 0.6rem; 
            width: 100%; 
            font-size: 16px; 
            margin-bottom: 8px; 
            transition: border-color 0.2s;
        }
        input:focus, select:focus, textarea:focus {
            border-color: var(--primary) !important;
            outline: none;
        }

        /* Estilo de Bot√≥n Principal */
        .btn-blue { 
            background: #2563eb; 
            color: white; 
            font-weight: bold; 
            padding: 1rem; 
            border-radius: 0.6rem; 
            width: 100%; 
            transition: 0.2s; 
            border: none; 
            cursor: pointer; 
        }
        .btn-blue:active { background: #1d4ed8; transform: scale(0.98); }

        /* Estilo de Navegaci√≥n (Ajuste Final UI/UX) */
        .nav-bar {
            background: var(--card-bg);
            border-top: 1px solid #334155;
            box-shadow: 0 -4px 10px rgba(0, 0, 0, 0.2);
            padding: 4px; 
        }
        .nav-btn { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            font-size: 0.65rem; 
            color: #94a3b8; 
            flex: 1; 
            padding: 8px 0; 
            border:none; 
            background:none; 
            transition: color 0.2s, transform 0.1s, background 0.2s;
            border-radius: 8px; 
            margin: 0 4px;
        }
        .nav-btn:hover { background: rgba(255, 255, 255, 0.05); }
        .nav-btn:active { transform: scale(0.95); }
        .nav-active { 
            color: var(--primary); 
            font-weight: bold;
            background: rgba(59, 130, 246, 0.15); 
        }
        .nav-btn i { margin-bottom: 2px; }

        /* Estilos de Tarjeta (Card) - Nuevo Estilo */
        .card {
            background: var(--card-bg);
            border-radius: 1rem;
            padding: 1rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 1rem;
            transition: background 0.2s;
        }
        .card.selected {
            background: rgba(59, 130, 246, 0.3); /* Fondo azul para selecci√≥n */
        }

        /* Estilo para la Notificaci√≥n Sutil */
        #notification {
            position: fixed;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            background-color: #10b981; /* Emerald 500 */
            color: white;
            padding: 10px 20px;
            border-radius: 0 0 8px 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            font-weight: bold;
        }
        #notification.show {
            opacity: 1;
        }

        /* Bot√≥n Flotante de Edici√≥n (FAB) - Redise√±o v8 */
        .fab {
            position: fixed;
            bottom: 80px;
            right: 20px;
            padding: 12px 18px; /* Nuevo padding para bot√≥n rectangular */
            border-radius: 10px; /* Bordes redondeados */
            background-color: #ef4444; /* Rojo para Borrar */
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
            z-index: 900;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.2s;
            font-weight: bold;
            font-size: 1rem;
        }
        .fab:active { transform: scale(0.95); }
        .fab.active { background-color: #10b981; } /* Verde para Salir del modo */
        .fab i { margin-right: 8px; }

        /* Modal de Confirmaci√≥n Personalizado (v8) */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 1rem;
            max-width: 300px;
            text-align: center;
            transform: scale(0.9);
            transition: transform 0.3s;
        }
        .modal-overlay.show .modal-content {
            transform: scale(1);
        }
        .modal-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }
        .modal-buttons button {
            flex: 1;
            padding: 10px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .modal-buttons .btn-cancel {
            background: #334155;
            color: white;
            margin-right: 10px;
        }
        .modal-buttons .btn-confirm {
            background: #ef4444;
            color: white;
        }
        .modal-buttons .btn-cancel:hover { background: #475569; }
        .modal-buttons .btn-confirm:hover { background: #dc2626; }
    </style>
</head>
<body class="pb-24">

    <!-- NOTIFICACI√ìN SUTIL -->
    <div id="notification"></div>

    <!-- MODAL DE CONFIRMACI√ìN PERSONALIZADO (v8) -->
    <div id="custom-confirm-modal" class="modal-overlay">
        <div class="modal-content">
            <p id="modal-message" class="text-lg font-semibold mb-4"></p>
            <div class="modal-buttons">
                <button class="btn-cancel" onclick="modalCallback(false)">CANCELAR</button>
                <button class="btn-confirm" onclick="modalCallback(true)">CONFIRMAR</button>
            </div>
        </div>
    </div>

    <!-- PANTALLA DE BIENVENIDA PERSONALIZADA -->
    <div id="welcome" class="fixed inset-0 z-50 bg-[#0f172a] flex flex-col items-center justify-center p-6 text-center">
        <div class="w-32 h-32 bg-white p-4 rounded-3xl mb-6 shadow-2xl">
            <img src="aa.jpg" alt="Logo" class="w-full h-full object-contain">
        </div>
        <h1 class="text-3xl font-black mb-1 uppercase text-blue-400">MULTI SERVICIOS LARA</h1>
        <p class="text-slate-400 text-lg mb-1">Servicio de Transporte Privado</p>
        <p class="text-blue-300 font-semibold mb-10 italic">"Moviendo Vidas"</p>
        <button onclick="document.getElementById('welcome').style.display='none'" class="btn-blue w-full max-w-xs">ENTRAR</button>
    </div>

    <header class="p-4 flex justify-between items-center glass sticky top-0 z-30">
        <span id="section-title" class="font-bold text-blue-400 uppercase tracking-tighter text-sm">REGISTROS</span>
        <img src="aa.jpg" class="h-8 w-8 rounded-lg object-cover bg-white">
    </header>

    <main class="p-4 max-w-md mx-auto">
        <!-- SECCI√ìN REGISTROS -->
        <section id="sec-registros" class="space-y-4">
            <div class="card">
                <label class="text-[10px] font-bold text-slate-500 uppercase">Fecha</label>
                <input type="date" id="reg-fecha">
                
                <label class="text-[10px] font-bold text-slate-500 uppercase">Tipo de Flujo</label>
                <select id="reg-tipo-flujo">
                    <option value="Ingreso">üü¢ Ingreso</option>
                    <option value="Gasto">üî¥ Gasto</option>
                </select>
                
                <label class="text-[10px] font-bold text-slate-500 uppercase">Categor√≠a</label>
                <select id="reg-categoria">
                    <option value="Uber Diario">üöï Uber Diario</option>
                    <option value="Renta Carro">üîë Renta Carro</option>
                    <option value="Mantenimiento">üõ†Ô∏è Mantenimiento</option>
                    <option value="Internet">üåê Internet</option>
                    <option value="Gasolina">‚õΩ Gasolina</option>
                    <option value="Privado">üë§ Privado</option>
                    <option value="Otros">üì¶ Otros</option>
                </select>
                
                <label class="text-[10px] font-bold text-slate-500 uppercase">Monto (Q)</label>
                <input type="number" id="reg-monto" placeholder="0.00" inputmode="decimal">
                
                <textarea id="reg-concepto" placeholder="Notas adicionales..."></textarea>
                
                <button type="button" onclick="saveRegistro()" class="btn-blue mt-2">GUARDAR REGISTRO</button>
            </div>
            <!-- FILTRO DE FECHA -->
            <div class="card">
                <label class="text-[10px] font-bold text-slate-500 uppercase">Filtrar por Fecha</label>
                <input type="date" id="reg-filtro-fecha" onchange="renderRegistrosList()">
            </div>
            <!-- VISTA DE REGISTROS -->
            <div id="registros-list" class="space-y-3">
                <div class="p-4 text-center text-slate-400">Cargando registros...</div>
            </div>
        </section>

        <!-- SECCI√ìN VIAJES -->
        <section id="sec-viajes" class="hidden space-y-4">
            <div class="card">
                <input type="text" id="v-cliente" placeholder="Cliente">
                <input type="text" id="v-inicio" placeholder="Origen">
                <input type="text" id="v-fin" placeholder="Destino">
                <input type="number" id="v-costo" placeholder="Costo Q">
                <input type="date" id="v-fecha">
                <select id="v-tipo">
                    <option value="Cotizaci√≥n">üìÑ Cotizaci√≥n</option>
                    <option value="Agendado">üìÖ Agendado</option>
                    <option value="Realizado">‚úÖ Realizado</option>
                </select>
                <button type="button" onclick="saveViaje()" class="btn-blue">GUARDAR VIAJE</button>
            </div>
            <!-- VISTA DE VIAJES -->
            <div id="viajes-list" class="space-y-3">
                <div class="p-4 text-center text-slate-400">Cargando viajes...</div>
            </div>
        </section>

        <!-- SECCI√ìN DIEZMOS -->
        <section id="sec-diezmos" class="hidden space-y-4">
            <div id="diezmo-info" class="card bg-blue-900/20 border-blue-500/30"></div>
            <div class="card">
                <!-- CAMPO TIPO DE PAGO -->
                <label class="text-[10px] font-bold text-slate-500 uppercase">Tipo de Pago</label>
                <select id="d-tipo-pago">
                    <option value="Efectivo">üíµ Efectivo</option>
                    <option value="Transferencia">üí≥ Transferencia</option>
                </select>
                
                <input type="number" id="d-pago" placeholder="Monto a pagar Q">
                <button type="button" onclick="saveDiezmo()" class="w-full bg-emerald-600 py-4 rounded-xl font-bold">REGISTRAR PAGO</button>
            </div>
            <!-- VISTA DE PAGOS DE DIEZMO -->
            <div id="diezmo-pagos-list" class="space-y-3">
                <div class="p-4 text-center text-slate-400">Cargando historial de pagos...</div>
            </div>
        </section>

        <!-- SECCI√ìN RESUMEN DETALLADO -->
        <section id="sec-resumen" class="hidden space-y-4">
            <div id="resumen-container"></div>
            <div id="resumen-ingresos-gastos"></div>
            <div id="resumen-categorias"></div>
        </section>
    </main>

    <!-- Bot√≥n Flotante de Edici√≥n (FAB) - Redise√±o v8 -->
    <div id="fab" class="fab" onclick="toggleEditMode()">
        <i data-lucide="trash-2" class="w-5 h-5"></i>
        <span id="fab-text">BORRAR</span>
    </div>

    <!-- BARRA DE NAVEGACI√ìN -->
    <nav class="nav-bar fixed bottom-0 left-0 right-0 z-50">
        <div class="flex justify-around max-w-md mx-auto">
            <button class="nav-btn nav-active" onclick="showSection('registros')">
                <i data-lucide="wallet" class="w-5 h-5"></i>
                REGISTROS
            </button>
            <button class="nav-btn" onclick="showSection('viajes')">
                <i data-lucide="car" class="w-5 h-5"></i>
                VIAJES
            </button>
            <button class="nav-btn" onclick="showSection('diezmos')">
                <i data-lucide="church" class="w-5 h-5"></i>
                DIEZMOS
            </button>
            <button class="nav-btn" onclick="showSection('resumen')">
                <i data-lucide="bar-chart-3" class="w-5 h-5"></i>
                RESUMEN
            </button>
        </div>
    </nav>

    <script>
        // Variables Globales
        const DB_NAME = 'lara_control_db';
        let db = {};
        let editMode = false;
        let selectedItems = [];
        let currentSection = 'registros';
        let modalCallback = null; // Para el nuevo modal de confirmaci√≥n

        // --- FUNCIONES DEL MODAL DE CONFIRMACI√ìN (v8) ---
        function showConfirmModal(message, callback) {
            document.getElementById('modal-message').innerText = message;
            document.getElementById('custom-confirm-modal').classList.add('show');
            modalCallback = callback;
        }

        function modalCallback(result) {
            document.getElementById('custom-confirm-modal').classList.remove('show');
            if (modalCallback) {
                modalCallback(result);
                modalCallback = null;
            }
        }

        // --- UTILIDADES ---

        function showNotification(message) {
            const notification = document.getElementById('notification');
            notification.innerText = message;
            notification.classList.add('show');
            setTimeout(() => {
                notification.classList.remove('show');
            }, 2000);
        }

        function formatDate(dateString) {
            const date = new Date(dateString + 'T00:00:00'); // A√±adir T00:00:00 para evitar problemas de zona horaria
            return date.toLocaleDateString('es-MX', { day: '2-digit', month: 'short', year: 'numeric' });
        }

        function normalizeDate(dateString) {
            const date = new Date(dateString);
            date.setHours(0, 0, 0, 0);
            return date;
        }

        const formatter = new Intl.NumberFormat('es-GT', {
            style: 'currency',
            currency: 'GTQ',
            minimumFractionDigits: 2,
        });

        // --- MANEJO DE BASE DE DATOS (localForage) ---

        async function loadDB() {
            try {
                const data = await localforage.getItem(DB_NAME);
                db = data || { registros: [], viajes: [], diezmos: [] };
                renderAllLists();
                updateResumen();
                updateDiezmosView();
                lucide.createIcons();
            } catch (err) {
                console.error("Error al cargar la base de datos:", err);
            }
        }

        async function saveDB() {
            try {
                await localforage.setItem(DB_NAME, db);
            } catch (err) {
                console.error("Error al guardar la base de datos:", err);
            }
        }

        // --- MANEJO DE SECCIONES Y NAVEGACI√ìN ---

        function showSection(sectionId) {
            currentSection = sectionId;
            const sections = ['registros', 'viajes', 'diezmos', 'resumen'];
            sections.forEach(id => {
                document.getElementById(`sec-${id}`).classList.add('hidden');
            });
            document.getElementById(`sec-${sectionId}`).classList.remove('hidden');
            document.getElementById('section-title').innerText = sectionId.toUpperCase();

            // Actualizar botones de navegaci√≥n
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('nav-active');
            });
            document.querySelector(`.nav-btn[onclick="showSection('${sectionId}')"]`).classList.add('nav-active');

            // Mostrar/Ocultar FAB
            const fab = document.getElementById('fab');
            if (sectionId === 'registros' || sectionId === 'viajes' || sectionId === 'diezmos') {
                fab.classList.remove('hidden');
            } else {
                fab.classList.add('hidden');
            }

            // Si se cambia de secci√≥n, salir del modo edici√≥n
            if (editMode) {
                toggleEditMode();
            }

            // Renderizar la lista de la secci√≥n activa
            renderAllLists();
            if (sectionId === 'resumen') {
                updateResumen();
                renderMonthlyDetails();
            }
            if (sectionId === 'diezmos') {
                updateDiezmosView();
            }
            lucide.createIcons();
        }

        function renderAllLists() {
            renderRegistrosList();
            renderViajesList();
            renderDiezmoPagosList();
        }

        // --- MANEJO DEL MODO EDICI√ìN/BORRADO (v8) ---

        function toggleEditMode() {
            editMode = !editMode;
            const fab = document.getElementById('fab');
            const fabIcon = fab.querySelector('i');
            const fabText = document.getElementById('fab-text');

            fab.classList.toggle('active', editMode);
            
            if (editMode) {
                // Entrando en modo edici√≥n
                fabIcon.setAttribute('data-lucide', 'x');
                fabText.innerText = 'SALIR';
                selectedItems = [];
            } else {
                // Saliendo de modo edici√≥n
                if (selectedItems.length > 0) {
                    // Si hay elementos seleccionados, preguntar si borrar
                    deleteSelectedItems();
                    return; // Esperar la respuesta del modal
                } else {
                    // Si no hay selecci√≥n, simplemente salir del modo
                    fabIcon.setAttribute('data-lucide', 'trash-2');
                    fabText.innerText = 'BORRAR';
                }
            }
            
            renderAllLists();
            lucide.createIcons();
        }

        function selectItem(index, element) {
            const id = `${currentSection}-${index}`;
            const checkbox = element.querySelector('input[type="checkbox"]');

            if (selectedItems.includes(id)) {
                selectedItems = selectedItems.filter(item => item !== id);
                element.classList.remove('selected');
                if (checkbox) checkbox.checked = false;
            } else {
                selectedItems.push(id);
                element.classList.add('selected');
                if (checkbox) checkbox.checked = true;
            }

            // Actualizar el FAB para reflejar la selecci√≥n
            const fab = document.getElementById('fab');
            const fabText = document.getElementById('fab-text');
            if (selectedItems.length > 0) {
                fab.style.backgroundColor = '#ef4444'; // Rojo para borrar
                fabText.innerText = `BORRAR (${selectedItems.length})`;
            } else {
                fab.style.backgroundColor = '#10b981'; // Verde para salir
                fabText.innerText = 'SALIR';
            }
        }

        async function deleteSelectedItems() {
            if (selectedItems.length === 0) {
                showNotification("‚ùå No hay elementos seleccionados para borrar.");
                return;
            }

            const message = `¬øEst√°s seguro de que deseas borrar ${selectedItems.length} elementos seleccionados? Esta acci√≥n es irreversible.`;

            showConfirmModal(message, async (confirmed) => {
                if (confirmed) {
                    let count = 0;
                    const itemsToDelete = [...selectedItems]; // Copia para evitar mutaci√≥n durante el borrado

                    // Borrar registros
                    const regIndices = itemsToDelete
                        .filter(id => id.startsWith('registros-'))
                        .map(id => parseInt(id.split('-')[1]))
                        .sort((a, b) => b - a); // Ordenar descendente para borrar sin afectar √≠ndices menores
                    
                    regIndices.forEach(index => {
                        db.registros.splice(index, 1);
                        count++;
                    });

                    // Borrar viajes
                    const viaIndices = itemsToDelete
                        .filter(id => id.startsWith('viajes-'))
                        .map(id => parseInt(id.split('-')[1]))
                        .sort((a, b) => b - a);
                    
                    viaIndices.forEach(index => {
                        db.viajes.splice(index, 1);
                        count++;
                    });

                    // Borrar diezmos
                    const diezmoIndices = itemsToDelete
                        .filter(id => id.startsWith('diezmos-'))
                        .map(id => parseInt(id.split('-')[1]))
                        .sort((a, b) => b - a);
                    
                    diezmoIndices.forEach(index => {
                        db.diezmos.splice(index, 1);
                        count++;
                    });

                    await saveDB();
                    showNotification(`üóëÔ∏è ${count} elementos borrados.`);
                    selectedItems = []; // Limpiar selecci√≥n despu√©s de borrar
                    
                    // Resetear el FAB y el modo edici√≥n
                    const fab = document.getElementById('fab');
                    const fabIcon = fab.querySelector('i');
                    const fabText = document.getElementById('fab-text');
                    fabIcon.setAttribute('data-lucide', 'trash-2');
                    fabText.innerText = 'BORRAR';
                    fab.classList.remove('active');
                    editMode = false;

                    renderAllLists();
                    lucide.createIcons();
                } else {
                    // Si el usuario cancela, salir del modo edici√≥n y limpiar selecci√≥n
                    selectedItems = [];
                    const fab = document.getElementById('fab');
                    const fabIcon = fab.querySelector('i');
                    const fabText = document.getElementById('fab-text');
                    fabIcon.setAttribute('data-lucide', 'trash-2');
                    fabText.innerText = 'BORRAR';
                    fab.classList.remove('active');
                    editMode = false;
                    renderAllLists();
                    lucide.createIcons();
                }
            });
        }

        // --- FUNCIONES DE RENDERIZADO DE LISTAS (con enumeraci√≥n v8) ---

        function renderRegistrosList() {
            const container = document.getElementById('registros-list');
            const filtroFecha = document.getElementById('reg-filtro-fecha').value;

            if (!db.registros || db.registros.length === 0) {
                container.innerHTML = '<div class="p-4 text-center text-slate-400">No hay registros guardados.</div>';
                return;
            }

            // 1. Mapear con √≠ndice original
            let registrosWithIndex = db.registros.map((r, index) => ({...r, originalIndex: index}));

            // 2. Filtrar por fecha si est√° seleccionada
            if (filtroFecha) {
                registrosWithIndex = registrosWithIndex.filter(r => r.fecha === filtroFecha);
            }

            // 3. Ordenar: M√°s reciente primero (descendente)
            const sortedRegistros = registrosWithIndex.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));

            let html = '';
            sortedRegistros.forEach((r, i) => {
                const color = r.flujo === 'Ingreso' ? 'text-emerald-400' : 'text-red-400';
                const sign = r.flujo === 'Ingreso' ? '+' : '-';
                const isSelected = selectedItems.includes(`registros-${r.originalIndex}`) ? 'selected' : '';

                html += `
                    <div class="card flex items-center ${isSelected}" onclick="if(editMode) selectItem(${r.originalIndex}, this)">
                        ${editMode ? `<input type="checkbox" class="mr-3 w-5 h-5" ${isSelected ? 'checked' : ''} onclick="event.stopPropagation(); selectItem(${r.originalIndex}, this.parentNode)">` : ''}
                        <div class="text-xs font-bold text-slate-500 mr-3">${i + 1}.</div> <!-- ENUMERACI√ìN V8 -->
                        <div class="flex-1">
                            <p class="text-sm font-bold ${color}">${r.cat} (${r.flujo})</p>
                            <p class="text-xs text-slate-400">${formatDate(r.fecha)}</p>
                            <p class="text-xs text-slate-500">${r.concepto || 'Sin notas'}</p>
                        </div>
                        <div class="text-right">
                            <p class="text-lg font-black ${color}">${sign}${formatter.format(r.monto).replace('GTQ', 'Q')}</p>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
            lucide.createIcons(); 
        }

        function renderViajesList() {
            const container = document.getElementById('viajes-list');
            if (!db.viajes || db.viajes.length === 0) {
                container.innerHTML = '<div class="p-4 text-center text-slate-400">No hay viajes guardados.</div>';
                return;
            }

            // 1. Mapear con √≠ndice original
            const viajesWithIndex = db.viajes.map((v, index) => ({...v, originalIndex: index}));

            // 2. Ordenar: M√°s reciente primero (descendente)
            const sortedViajes = viajesWithIndex.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));

            let html = '';
            sortedViajes.forEach((v, i) => {
                const color = v.tipo === 'Realizado' ? 'text-emerald-400' : 'text-blue-400';
                const isSelected = selectedItems.includes(`viajes-${v.originalIndex}`) ? 'selected' : '';

                html += `
                    <div class="card flex items-center ${isSelected}" onclick="if(editMode) selectItem(${v.originalIndex}, this)">
                        ${editMode ? `<input type="checkbox" class="mr-3 w-5 h-5" ${isSelected ? 'checked' : ''} onclick="event.stopPropagation(); selectItem(${v.originalIndex}, this.parentNode)">` : ''}
                        <div class="text-xs font-bold text-slate-500 mr-3">${i + 1}.</div> <!-- ENUMERACI√ìN V8 -->
                        <div class="flex-1">
                            <p class="text-sm font-bold">${v.cliente}</p>
                            <p class="text-xs text-slate-400">${formatDate(v.fecha)} - ${v.tipo}</p>
                            <p class="text-xs text-slate-500">${v.inicio} a ${v.fin}</p>
                        </div>
                        <div class="text-right">
                            <p class="text-lg font-black ${color}">${formatter.format(v.costo).replace('GTQ', 'Q')}</p>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
            lucide.createIcons(); 
        }

        function renderDiezmoPagosList() {
            const container = document.getElementById('diezmo-pagos-list');
            if (!db.diezmos || db.diezmos.length === 0) {
                container.innerHTML = '<div class="p-4 text-center text-slate-400">No hay pagos de diezmo registrados.</div>';
                return;
            }

            // 1. Mapear con √≠ndice original
            const diezmosWithIndex = db.diezmos.map((d, index) => ({...d, originalIndex: index}));

            // 2. Ordenar: M√°s reciente primero (descendente)
            const sortedDiezmos = diezmosWithIndex.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));

            let html = '';
            sortedDiezmos.forEach((d, i) => {
                const isSelected = selectedItems.includes(`diezmos-${d.originalIndex}`) ? 'selected' : '';

                html += `
                    <div class="card flex items-center ${isSelected}" onclick="if(editMode) selectItem(${d.originalIndex}, this)">
                        ${editMode ? `<input type="checkbox" class="mr-3 w-5 h-5" ${isSelected ? 'checked' : ''} onclick="event.stopPropagation(); selectItem(${d.originalIndex}, this.parentNode)">` : ''}
                        <div class="text-xs font-bold text-slate-500 mr-3">${i + 1}.</div> <!-- ENUMERACI√ìN V8 -->
                        <div class="flex-1">
                            <p class="text-sm font-bold text-blue-400">Pago de Diezmo</p>
                            <p class="text-xs text-slate-400">${formatDate(d.fecha)}</p>
                            <p class="text-xs text-slate-500">${d.tipo}</p>
                        </div>
                        <div class="text-right">
                            <p class="text-lg font-black text-blue-400">${formatter.format(d.monto).replace('GTQ', 'Q')}</p>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
            lucide.createIcons();
        }

        // --- FUNCIONES DE GUARDADO ---

        async function saveRegistro() {
            const monto = parseFloat(document.getElementById('reg-monto').value);
            
            if(isNaN(monto)) { 
                showNotification("‚ùå Ingresa un monto v√°lido."); 
                return; 
            }
            
            if (!db.registros) {
                db.registros = [];
            }

            db.registros.push({
                fecha: document.getElementById('reg-fecha').value,
                flujo: document.getElementById('reg-tipo-flujo').value,
                cat: document.getElementById('reg-categoria').value,
                monto: monto,
                concepto: document.getElementById('reg-concepto').value
            });
            
            await saveDB();
            showNotification("‚úÖ Registro guardado.");
            document.getElementById('reg-monto').value = '';
            document.getElementById('reg-concepto').value = '';
            renderRegistrosList(); 
        }

        async function saveViaje() {
            const costo = parseFloat(document.getElementById('v-costo').value);
            if(isNaN(costo)) { 
                showNotification("‚ùå Ingresa un costo v√°lido."); 
                return; 
            }

            if (!db.viajes) {
                db.viajes = [];
            }

            db.viajes.push({
                cliente: document.getElementById('v-cliente').value,
                inicio: document.getElementById('v-inicio').value,
                fin: document.getElementById('v-fin').value,
                costo: costo,
                fecha: document.getElementById('v-fecha').value,
                tipo: document.getElementById('v-tipo').value
            });
            await saveDB(); 
            showNotification("‚úÖ Viaje guardado.");
            // Limpiar campos despu√©s de guardar
            document.getElementById('v-cliente').value = '';
            document.getElementById('v-inicio').value = '';
            document.getElementById('v-fin').value = '';
            document.getElementById('v-costo').value = '';
            renderViajesList(); 
        }

        async function saveDiezmo() {
            const m = parseFloat(document.getElementById('d-pago').value);
            const tipoPago = document.getElementById('d-tipo-pago').value; 
            
            if(isNaN(m) || m <= 0) {
                showNotification("‚ùå Ingresa un monto de pago v√°lido.");
                return;
            }

            if (!db.diezmos) {
                db.diezmos = [];
            }

            db.diezmos.push({ 
                monto: m, 
                fecha: new Date().toISOString().split('T')[0],
                tipo: tipoPago
            }); 
            await saveDB(); 
            updateDiezmosView();
            document.getElementById('d-pago').value = '';
            showNotification("üôè Diezmo registrado.");
        }

        // --- FUNCIONES DE RESUMEN Y DIEZMOS ---

        function getNetoForRange(start, end) {
            let ing = 0;
            let gas = 0;

            if (db.registros) {
                db.registros.forEach(r => {
                    const f = normalizeDate(r.fecha);
                    if (f >= start && f <= end) {
                        if (r.flujo === 'Ingreso') {
                            ing += r.monto;
                        } else {
                            gas += r.monto;
                        }
                    }
                });
            }
            return { ing, gas, neto: ing - gas };
        }

        function renderMonthlyDetails() {
            const container = document.getElementById('resumen-ingresos-gastos');
            const hoy = new Date();
            const startOfMonth = new Date(hoy.getFullYear(), hoy.getMonth(), 1);
            const endOfMonth = new Date(hoy.getFullYear(), hoy.getMonth() + 1, 0);
            endOfMonth.setHours(23, 59, 59, 999);

            const registrosMes = db.registros.filter(r => {
                const f = normalizeDate(r.fecha);
                return f >= startOfMonth && f <= endOfMonth;
            }).sort((a, b) => new Date(b.fecha) - new Date(a.fecha)); 

            const ingresos = registrosMes.filter(r => r.flujo === 'Ingreso');
            const gastos = registrosMes.filter(r => r.flujo === 'Gasto');

            let html = `
                <h3 class="text-sm font-bold text-emerald-400 mb-3 uppercase">Ingresos del Mes (${hoy.toLocaleDateString('es-MX', { month: 'long', year: 'numeric' })})</h3>
                <div class="space-y-3">
            `;
            if (ingresos.length === 0) {
                html += '<div class="card text-center text-slate-400">No hay ingresos este mes.</div>';
            } else {
                ingresos.forEach(r => {
                    html += `
                        <div class="card flex justify-between items-center">
                            <div class="flex-1">
                                <p class="text-sm font-bold">${r.cat}</p>
                                <p class="text-xs text-slate-400">${formatDate(r.fecha)}</p>
                            </div>
                            <div class="text-right">
                                <p class="text-lg font-black text-emerald-400">+${formatter.format(r.monto).replace('GTQ', 'Q')}</p>
                            </div>
                        </div>
                    `;
                });
            }
            html += '</div>';

            html += `
                <h3 class="text-sm font-bold text-red-400 mb-3 uppercase mt-6">Gastos del Mes (${hoy.toLocaleDateString('es-MX', { month: 'long', year: 'numeric' })})</h3>
                <div class="space-y-3">
            `;
            if (gastos.length === 0) {
                html += '<div class="card text-center text-slate-400">No hay gastos este mes.</div>';
            } else {
                gastos.forEach(r => {
                    html += `
                        <div class="card flex justify-between items-center">
                            <div class="flex-1">
                                <p class="text-sm font-bold">${r.cat}</p>
                                <p class="text-xs text-slate-400">${formatDate(r.fecha)}</p>
                            </div>
                            <div class="text-right">
                                <p class="text-lg font-black text-red-400">-${formatter.format(r.monto).replace('GTQ', 'Q')}</p>
                            </div>
                        </div>
                    `;
                });
            }
            html += '</div>';

            container.innerHTML = html;
        }

        function updateResumen() {
            // 1. Resumen Semanal (Mantenido)
            const hoy = new Date();
            const day = hoy.getDay() || 7; 
            const lunes = new Date(hoy); lunes.setDate(hoy.getDate() - day + 1); lunes.setHours(0,0,0,0);
            const dom = new Date(lunes); dom.setDate(lunes.getDate() + 6); dom.setHours(23,59,59,999);

            const { ing: ingSemanal, gas: gasSemanal, neto: netoSemanal } = getNetoForRange(lunes, dom);

            document.getElementById('resumen-container').innerHTML = `
                <div class="card p-6 text-center border-b-4 border-blue-500 mb-4">
                    <p class="text-slate-400 text-[10px] uppercase">Ganancia Neta Semanal</p>
                    <h4 class="text-4xl font-black text-blue-400 my-2">${formatter.format(netoSemanal).replace('GTQ', 'Q')}</h4>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div class="card p-4 text-center"><p class="text-[10px] text-slate-400">INGRESOS</p><p class="text-lg font-bold text-emerald-400">${formatter.format(ingSemanal).replace('GTQ', 'Q')}</p></div>
                    <div class="card p-4 text-center"><p class="text-[10px] text-slate-400">GASTOS</p><p class="text-lg font-bold text-red-400">${formatter.format(gasSemanal).replace('GTQ', 'Q')}</p></div>
                </div>`;

            // 2. Resumen por Categor√≠as
            const categorias = {};
            if (db.registros) {
                db.registros.forEach(r => {
                    if (!categorias[r.cat]) {
                        categorias[r.cat] = { Ingreso: 0, Gasto: 0 };
                    }
                    categorias[r.cat][r.flujo] += r.monto;
                });
            }

            let catHtml = '<h3 class="text-sm font-bold text-blue-400 mb-3 uppercase mt-6">Desglose por Categor√≠a</h3>';
            catHtml += '<div class="space-y-3">';

            const sortedCats = Object.keys(categorias).sort();

            sortedCats.forEach(cat => {
                const ing = categorias[cat].Ingreso;
                const gas = categorias[cat].Gasto;
                const neto = ing - gas;
                const color = neto >= 0 ? 'text-emerald-400' : 'text-red-400';

                catHtml += `
                    <div class="card flex justify-between items-center">
                        <div class="flex-1">
                            <p class="text-sm font-bold">${cat}</p>
                            <p class="text-xs text-slate-400">Ingresos: ${formatter.format(ing).replace('GTQ', 'Q')} | Gastos: ${formatter.format(gas).replace('GTQ', 'Q')}</p>
                        </div>
                        <div class="text-right">
                            <p class="text-lg font-black ${color}">${formatter.format(neto).replace('GTQ', 'Q')}</p>
                        </div>
                    </div>
                `;
            });

            catHtml += '</div>';
            document.getElementById('resumen-categorias').innerHTML = catHtml;
        }

        function updateDiezmosView() {
            let totalIngresos = 0;
            if (db.registros) {
                totalIngresos = db.registros
                    .filter(r => r.flujo === 'Ingreso')
                    .reduce((sum, r) => sum + r.monto, 0);
            }

            const diezmoEsperado = totalIngresos * 0.10;

            let totalPagado = 0;
            if (db.diezmos) {
                totalPagado = db.diezmos.reduce((sum, d) => sum + d.monto, 0);
            }

            const pendiente = diezmoEsperado - totalPagado;
            const color = pendiente <= 0 ? 'text-emerald-400' : 'text-red-400';
            const status = pendiente <= 0 ? 'AL D√çA' : 'PENDIENTE';

            document.getElementById('diezmo-info').innerHTML = `
                <h3 class="text-sm font-bold text-blue-400 mb-3 uppercase">Resumen de Diezmos</h3>
                <div class="flex justify-between items-center mb-2">
                    <p class="text-sm text-slate-400">Ingreso Total:</p>
                    <p class="text-sm font-bold text-emerald-400">${formatter.format(totalIngresos).replace('GTQ', 'Q')}</p>
                </div>
                <div class="flex justify-between items-center mb-2">
                    <p class="text-sm text-slate-400">Diezmo Esperado (10%):</p>
                    <p class="text-sm font-bold text-blue-400">${formatter.format(diezmoEsperado).replace('GTQ', 'Q')}</p>
                </div>
                <div class="flex justify-between items-center mb-2">
                    <p class="text-sm text-slate-400">Total Pagado:</p>
                    <p class="text-sm font-bold text-blue-400">${formatter.format(totalPagado).replace('GTQ', 'Q')}</p>
                </div>
                <div class="flex justify-between items-center pt-2 border-t border-slate-600">
                    <p class="text-lg font-bold">Estado:</p>
                    <p class="text-lg font-black ${color}">${status} (${formatter.format(pendiente).replace('GTQ', 'Q')})</p>
                </div>
            `;
            renderDiezmoPagosList();
        }

        // --- INICIALIZACI√ìN ---

        window.onload = () => {
            loadDB();
            // Establecer la fecha actual por defecto en los campos de fecha
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('reg-fecha').value = today;
            document.getElementById('v-fecha').value = today;
        };
    </script>
</body>
</html>
