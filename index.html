<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Multi Servicios LARA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lucide/0.263.0/lucide.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root { 
            --primary: #3b82f6;
            --bg: #0f172a;
            --card-bg: #1e293b;
            --text-color: #f1f5f9;
        }
        
        [data-theme="light"] {
            --bg: #f8fafc;
            --card-bg: #ffffff;
            --text-color: #0f172a;
        }
        
        * { box-sizing: border-box; }
        
        body { 
            background-color: var(--bg); 
            color: var(--text-color); 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin: 0;
            padding: 0;
            padding-bottom: 85px;
            transition: background-color 0.3s, color 0.3s;
        }
        
        .glass { 
            background: rgba(30, 41, 59, 0.9); 
            backdrop-filter: blur(12px); 
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        [data-theme="light"] .glass {
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid rgba(0,0,0,0.08);
        }
        
        input, select, textarea { 
            background: var(--card-bg) !important; 
            border: 1px solid #334155 !important; 
            color: var(--text-color) !important; 
            padding: 0.85rem !important;
            border-radius: 0.75rem; 
            width: 100%; 
            font-size: 16px;
            margin-bottom: 8px;
        }
        
        [data-theme="light"] input,
        [data-theme="light"] select,
        [data-theme="light"] textarea {
            border: 1px solid #cbd5e1 !important;
            background: #f8fafc !important;
        }
        
        input:focus, select:focus, textarea:focus {
            border-color: var(--primary) !important;
            outline: none;
        }
        
        textarea { min-height: 80px; resize: vertical; }

        .btn-primary { 
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white; 
            font-weight: bold; 
            padding: 1rem; 
            border-radius: 0.75rem; 
            width: 100%; 
            border: none; 
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 0.95rem;
            transition: transform 0.2s;
        }
        
        .btn-primary:active { 
            transform: scale(0.98);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }
        
        .btn-secondary {
            background: #64748b;
            box-shadow: 0 4px 15px rgba(100, 116, 139, 0.3);
        }

        .nav-bar {
            background: var(--card-bg);
            border-top: 1px solid #334155;
            box-shadow: 0 -4px 10px rgba(0, 0, 0, 0.2);
            padding: 6px 4px;
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 3px;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 40;
        }
        
        [data-theme="light"] .nav-bar {
            border-top: 1px solid #e2e8f0;
        }
        
        .nav-btn { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center;
            font-size: 0.65rem; 
            color: #94a3b8; 
            padding: 8px 2px;
            border: none; 
            background: transparent;
            border-radius: 10px;
            min-height: 64px;
            position: relative;
            font-weight: 500;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .nav-btn:active { 
            transform: scale(0.95); 
        }
        
        .nav-active { 
            color: white;
            font-weight: bold;
        }
        
        .nav-active::before {
            content: '';
            position: absolute;
            inset: 2px;
            background: linear-gradient(135deg, var(--primary) 0%, #1d4ed8 100%);
            border-radius: 10px;
            z-index: -1;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }
        
        .nav-btn .nav-icon {
            font-size: 20px;
            margin-bottom: 3px;
        }

        .card {
            background: var(--card-bg);
            border-radius: 1.25rem;
            padding: 1rem;
            margin-bottom: 1rem;
            border: 1px solid rgba(255,255,255,0.05);
            transition: transform 0.2s;
        }
        
        [data-theme="light"] .card {
            border: 1px solid #e2e8f0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        
        .card.clickable {
            cursor: pointer;
        }
        
        .card.clickable:active {
            transform: scale(0.98);
        }

        #notification {
            position: fixed;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            background-color: #10b981;
            color: white;
            padding: 12px 24px;
            border-radius: 0 0 12px 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 1001;
            opacity: 0;
            transition: opacity 0.3s;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
            pointer-events: none;
        }
        
        #notification.show {
            opacity: 1;
        }

        .fab {
            position: fixed;
            bottom: 95px;
            right: 20px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.5);
            z-index: 900;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .fab:active { 
            transform: scale(0.95); 
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.75);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 1rem;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .modal-overlay.show {
            display: flex;
            opacity: 1;
        }
        
        .modal-content {
            background: var(--card-bg);
            padding: 1.5rem;
            border-radius: 1.25rem;
            max-width: 420px;
            width: 100%;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        [data-theme="light"] .modal-content {
            border: 1px solid #e2e8f0;
        }

        .section-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 1.25rem;
        }
        
        .section-icon {
            width: 42px;
            height: 42px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            flex-shrink: 0;
        }

        /* TOGGLE DE TEMA */
        .theme-switch {
            position: relative;
            display: inline-block;
            width: 48px;
            height: 26px;
        }
        
        .theme-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .theme-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            transition: .3s;
            border-radius: 34px;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
        }
        
        .theme-slider:before {
            position: absolute;
            content: "üåô";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .3s;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }
        
        input:checked + .theme-slider {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
        }
        
        input:checked + .theme-slider:before {
            transform: translateX(22px);
            content: "‚òÄÔ∏è";
        }

        .hidden {
            display: none !important;
        }

        label {
            display: block;
            font-size: 0.7rem;
            font-weight: bold;
            color: #94a3b8;
            text-transform: uppercase;
            margin-bottom: 4px;
            letter-spacing: 0.5px;
        }
        
        [data-theme="light"] label {
            color: #64748b;
        }

        /* CALCULADORA */
        .calculator {
            background: var(--card-bg);
            border-radius: 1rem;
            padding: 1rem;
            border: 2px solid #3b82f6;
        }
        
        .calc-display {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid #3b82f6;
            border-radius: 0.5rem;
            padding: 1rem;
            text-align: right;
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 1rem;
            color: var(--text-color);
            min-height: 50px;
        }
        
        .calc-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.5rem;
        }
        
        .calc-btn {
            padding: 1rem;
            border-radius: 0.5rem;
            border: none;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.1s;
            background: rgba(100, 116, 139, 0.2);
            color: var(--text-color);
        }
        
        [data-theme="light"] .calc-btn {
            background: #e2e8f0;
        }
        
        .calc-btn:active {
            transform: scale(0.95);
        }
        
        .calc-btn.operator {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
        }
        
        .calc-btn.equals {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            grid-column: span 2;
        }
        
        .calc-btn.clear {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(148, 163, 184, 0.3);
            border-radius: 4px;
        }

        /* INDICADOR DE SINCRONIZACI√ìN */
        .sync-indicator {
            position: fixed;
            top: 70px;
            right: 20px;
            background: rgba(16, 185, 129, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: bold;
            display: none;
            align-items: center;
            gap: 6px;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }
        
        .sync-indicator.syncing {
            display: flex;
            background: rgba(59, 130, 246, 0.9);
        }
        
        .sync-indicator.error {
            display: flex;
            background: rgba(239, 68, 68, 0.9);
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .spinning {
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body>

    <!-- NOTIFICACI√ìN -->
    <div id="notification"></div>

    <!-- INDICADOR DE SINCRONIZACI√ìN -->
    <div id="sync-indicator" class="sync-indicator">
        <i data-lucide="cloud" class="w-4 h-4"></i>
        <span id="sync-text">Sincronizado</span>
    </div>

    <!-- PANTALLA DE BIENVENIDA -->
    <div id="welcome" class="fixed inset-0 z-50 bg-[#0f172a] flex flex-col items-center justify-center p-6 text-center">
        <div class="w-32 h-32 bg-white p-4 rounded-3xl mb-6 shadow-2xl">
            <div class="w-full h-full flex items-center justify-center text-6xl">üöó</div>
        </div>
        <h1 class="text-3xl font-black mb-1 uppercase text-blue-400">MULTI SERVICIOS LARA</h1>
        <p class="text-slate-400 text-lg mb-1">Servicio de Transporte Privado</p>
        <p class="text-blue-300 font-semibold mb-10 italic">"Moviendo Vidas"</p>
        <button onclick="closeWelcome()" class="btn-primary w-full max-w-xs">
            <i data-lucide="arrow-right" class="w-5 h-5"></i>
            ENTRAR
        </button>
    </div>

    <!-- HEADER -->
    <header class="p-4 flex justify-between items-center glass sticky top-0 z-30">
        <span id="section-title" class="font-bold text-blue-400 uppercase tracking-tight text-sm">INICIO</span>
        <div class="flex items-center gap-3">
            <label class="theme-switch">
                <input type="checkbox" id="theme-toggle" onchange="toggleTheme()">
                <span class="theme-slider"></span>
            </label>
            <div class="w-8 h-8 rounded-lg bg-blue-500 flex items-center justify-center text-white font-bold text-sm">L</div>
        </div>
    </header>

    <!-- MAIN -->
    <main class="p-4 max-w-md mx-auto">
        
        <!-- INICIO -->
        <section id="sec-inicio" class="space-y-4">
            <div class="section-header">
                <div class="section-icon bg-blue-500">üè†</div>
                <h2 class="text-xl font-bold text-blue-400">Panel de Control</h2>
            </div>
            
            <div class="card bg-gradient-to-br from-blue-600 to-blue-700 border-0">
                <p class="text-blue-100 text-xs font-bold uppercase mb-1">üí∞ Ganancia Neta (Mes Actual)</p>
                <h2 id="home-neto" class="text-4xl font-black text-white mb-4">Q 0.00</h2>
                <div class="grid grid-cols-2 gap-3">
                    <div class="bg-white/10 backdrop-blur p-3 rounded-xl">
                        <p class="text-xs text-blue-100 uppercase font-bold">Ingresos</p>
                        <p id="home-ingresos" class="text-lg font-bold text-white">Q 0.00</p>
                    </div>
                    <div class="bg-white/10 backdrop-blur p-3 rounded-xl">
                        <p class="text-xs text-blue-100 uppercase font-bold">Gastos</p>
                        <p id="home-gastos" class="text-lg font-bold text-white">Q 0.00</p>
                    </div>
                </div>
            </div>
            
            <div class="grid grid-cols-1 gap-3">
                <div class="card clickable flex items-center gap-4" onclick="nav('registros')">
                    <div class="bg-emerald-100 text-emerald-600 p-3 rounded-xl">
                        <i data-lucide="pen-tool" class="w-6 h-6"></i>
                    </div>
                    <div class="flex-1">
                        <h3 class="font-bold">üìù Nuevo Registro</h3>
                        <p class="text-xs text-slate-400">Ingresos y gastos</p>
                    </div>
                    <i data-lucide="chevron-right" class="text-slate-400"></i>
                </div>
                
                <div class="card clickable flex items-center gap-4" onclick="nav('viajes')">
                    <div class="bg-blue-100 text-blue-600 p-3 rounded-xl">
                        <i data-lucide="car" class="w-6 h-6"></i>
                    </div>
                    <div class="flex-1">
                        <h3 class="font-bold">üöó Nuevo Viaje</h3>
                        <p class="text-xs text-slate-400">Gesti√≥n de rutas</p>
                    </div>
                    <i data-lucide="chevron-right" class="text-slate-400"></i>
                </div>
                
                <div class="card clickable flex items-center gap-4" onclick="nav('diezmos')">
                    <div class="bg-purple-100 text-purple-600 p-3 rounded-xl">
                        <i data-lucide="heart" class="w-6 h-6"></i>
                    </div>
                    <div class="flex-1">
                        <h3 class="font-bold">üíö Diezmos</h3>
                        <p class="text-xs text-slate-400">C√°lculo quincenal</p>
                    </div>
                    <i data-lucide="chevron-right" class="text-slate-400"></i>
                </div>
            </div>
        </section>

        <!-- REGISTROS -->
        <section id="sec-registros" class="hidden space-y-4">
            <div class="section-header">
                <div class="section-icon bg-emerald-500">üìù</div>
                <h2 class="text-xl font-bold text-blue-400">Nuevo Registro</h2>
            </div>
            <div class="card">
                <label>üí∞ Tipo de Flujo</label>
                <select id="reg-tipo">
                    <option value="Ingreso">üü¢ Ingreso</option>
                    <option value="Gasto">üî¥ Gasto</option>
                </select>
                
                <label>üìÖ Fecha</label>
                <input type="date" id="reg-fecha">
                
                <label>üíµ Monto (Q)</label>
                <div class="flex gap-2">
                    <input type="number" id="reg-monto" placeholder="0.00" step="0.01" class="flex-1">
                    <button onclick="openCalculator('reg-monto')" class="bg-blue-500 text-white px-4 rounded-lg">
                        <i data-lucide="calculator" class="w-5 h-5"></i>
                    </button>
                </div>
                
                <label>üè∑Ô∏è Categor√≠a</label>
                <select id="reg-categoria"></select>
                
                <label>üìÑ Detalle / Concepto</label>
                <textarea id="reg-detalle" placeholder="Descripci√≥n opcional..."></textarea>
                
                <button onclick="saveRegistro()" class="btn-primary mt-2">
                    <i data-lucide="save" class="w-5 h-5"></i>
                    GUARDAR REGISTRO
                </button>
            </div>
        </section>

        <!-- HISTORIAL REGISTROS -->
        <section id="sec-historial-registros" class="hidden space-y-4">
            <div class="section-header">
                <div class="section-icon bg-purple-500">üìä</div>
                <div class="flex-1">
                    <h2 class="text-xl font-bold text-blue-400">Historial</h2>
                </div>
                <button onclick="showFilterModal()" class="bg-blue-500 text-white px-3 py-2 rounded-lg">
                    <i data-lucide="filter" class="w-5 h-5"></i>
                </button>
                <button onclick="exportToExcel()" class="bg-green-500 text-white px-3 py-2 rounded-lg">
                    <i data-lucide="download" class="w-5 h-5"></i>
                </button>
            </div>
            
            <div class="card">
                <div class="grid grid-cols-2 gap-2">
                    <div>
                        <label>Desde</label>
                        <input type="date" id="filter-fecha-desde" onchange="applyQuickFilters()">
                    </div>
                    <div>
                        <label>Hasta</label>
                        <input type="date" id="filter-fecha-hasta" onchange="applyQuickFilters()">
                    </div>
                </div>
            </div>
            
            <div id="registros-list"></div>
        </section>

        <!-- VIAJES -->
        <section id="sec-viajes" class="hidden space-y-4">
            <div class="section-header">
                <div class="section-icon bg-blue-500">üöó</div>
                <h2 class="text-xl font-bold text-blue-400">Nuevo Viaje</h2>
            </div>
            <div class="card">
                <label>üìÖ Fecha</label>
                <input type="date" id="viaje-fecha">
                
                <label>üë§ Cliente</label>
                <input type="text" id="viaje-cliente" placeholder="Nombre del cliente">
                
                <label>üìç Origen</label>
                <input type="text" id="viaje-inicio" placeholder="Punto de inicio">
                
                <label>üéØ Destino</label>
                <input type="text" id="viaje-fin" placeholder="Punto de destino">
                
                <label>üíµ Monto (Q) - Opcional</label>
                <div class="flex gap-2">
                    <input type="number" id="viaje-monto" placeholder="0.00" step="0.01" class="flex-1">
                    <button onclick="openCalculator('viaje-monto')" class="bg-blue-500 text-white px-4 rounded-lg">
                        <i data-lucide="calculator" class="w-5 h-5"></i>
                    </button>
                </div>
                
                <label>üìã Estado</label>
                <select id="viaje-estado">
                    <option value="Cotizaci√≥n">üìÑ Cotizaci√≥n</option>
                    <option value="Programado">üìÖ Programado</option>
                    <option value="Realizado">‚úÖ Realizado</option>
                </select>
                
                <label>üìù Condici√≥n</label>
                <input type="text" id="viaje-condicion" placeholder="Ej: Pago contra entrega">
                
                <label>üìÑ Detalle</label>
                <textarea id="viaje-detalle" placeholder="Detalles adicionales..."></textarea>
                
                <button onclick="saveViaje()" class="btn-primary mt-2">
                    <i data-lucide="save" class="w-5 h-5"></i>
                    GUARDAR VIAJE
                </button>
            </div>
        </section>

        <!-- HISTORIAL VIAJES -->
        <section id="sec-historial-viajes" class="hidden space-y-4">
            <div class="section-header">
                <div class="section-icon bg-orange-500">üó∫Ô∏è</div>
                <h2 class="text-xl font-bold text-blue-400">Historial de Viajes</h2>
            </div>
            <div id="viajes-list"></div>
        </section>

        <!-- DIEZMOS -->
        <section id="sec-diezmos" class="hidden space-y-4">
            <div class="section-header">
                <div class="section-icon bg-emerald-500">üíö</div>
                <h2 class="text-xl font-bold text-blue-400">Diezmos</h2>
            </div>
            
            <div class="card">
                <div class="grid grid-cols-2 gap-2 mb-3">
                    <div>
                        <label>Mes</label>
                        <input type="month" id="diezmo-month" onchange="calcularDiezmo()">
                    </div>
                    <div>
                        <label>Quincena</label>
                        <select id="diezmo-quincena" onchange="calcularDiezmo()">
                            <option value="1">1ra (1-15)</option>
                            <option value="2">2da (16-Fin)</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div id="diezmo-info" class="card bg-blue-900/20 border-blue-500/30"></div>
            
            <div class="card">
                <label>üí≥ M√©todo de Pago</label>
                <select id="diezmo-metodo">
                    <option value="Efectivo">üíµ Efectivo</option>
                    <option value="Transferencia">üí≥ Transferencia</option>
                </select>
                
                <label>üí∞ Monto a Pagar (Q)</label>
                <div class="flex gap-2">
                    <input type="number" id="diezmo-monto" placeholder="0.00" step="0.01" class="flex-1">
                    <button onclick="openCalculator('diezmo-monto')" class="bg-blue-500 text-white px-4 rounded-lg">
                        <i data-lucide="calculator" class="w-5 h-5"></i>
                    </button>
                </div>
                
                <button onclick="saveDiezmo()" class="btn-success mt-2">
                    <i data-lucide="check-circle" class="w-5 h-5"></i>
                    REGISTRAR PAGO
                </button>
            </div>
        </section>

        <!-- HISTORIAL DIEZMOS -->
        <section id="sec-historial-diezmos" class="hidden space-y-4">
            <div class="section-header">
                <div class="section-icon bg-teal-500">üìú</div>
                <h2 class="text-xl font-bold text-blue-400">Historial de Pagos</h2>
            </div>
            <div id="diezmos-list"></div>
        </section>

        <!-- RESUMEN -->
        <section id="sec-resumen" class="hidden space-y-4">
            <div class="section-header">
                <div class="section-icon bg-pink-500">üìà</div>
                <h2 class="text-xl font-bold text-blue-400">Resumen General</h2>
            </div>
            
            <div id="resumen-container"></div>
            
            <div class="card">
                <h3 class="text-sm font-bold text-blue-400 mb-3 uppercase">üõ†Ô∏è Herramientas</h3>
                <div class="space-y-2">
                    <button onclick="exportPDF()" class="btn-primary">
                        <i data-lucide="file-text" class="w-5 h-5"></i>
                        Exportar PDF
                    </button>
                    <button onclick="exportJSON()" class="btn-primary bg-gradient-to-r from-slate-600 to-slate-700">
                        <i data-lucide="download" class="w-5 h-5"></i>
                        Respaldar Datos (JSON)
                    </button>
                    <input type="file" id="import-file" class="hidden" accept=".json" onchange="importJSON(event)">
                    <button onclick="document.getElementById('import-file').click()" class="btn-primary bg-gradient-to-r from-slate-600 to-slate-700">
                        <i data-lucide="upload" class="w-5 h-5"></i>
                        Importar Respaldo
                    </button>
                </div>
            </div>
            
            <button onclick="borrarTodo()" class="w-full text-red-400 text-xs py-3 opacity-40">
                BORRAR TODOS LOS DATOS
            </button>
        </section>
    </main>

    <!-- FAB -->
    <div id="fab" class="fab hidden" onclick="openModal()">
        <i data-lucide="plus" class="w-6 h-6"></i>
    </div>

    <!-- NAVEGACI√ìN -->
    <nav class="nav-bar">
        <button onclick="nav('inicio')" id="n-inicio" class="nav-btn nav-active">
            <span class="nav-icon">üè†</span>
            <span>Inicio</span>
        </button>
        <button onclick="nav('registros')" id="n-registros" class="nav-btn">
            <span class="nav-icon">üìù</span>
            <span>Registro</span>
        </button>
        <button onclick="nav('historial-registros')" id="n-historial-registros" class="nav-btn">
            <span class="nav-icon">üìä</span>
            <span>Historial</span>
        </button>
        <button onclick="nav('viajes')" id="n-viajes" class="nav-btn">
            <span class="nav-icon">üöó</span>
            <span>Viajes</span>
        </button>
        <button onclick="nav('historial-viajes')" id="n-historial-viajes" class="nav-btn">
            <span class="nav-icon">üó∫Ô∏è</span>
            <span>Rutas</span>
        </button>
        <button onclick="nav('diezmos')" id="n-diezmos" class="nav-btn">
            <span class="nav-icon">üíö</span>
            <span>Diezmo</span>
        </button>
        <button onclick="nav('resumen')" id="n-resumen" class="nav-btn">
            <span class="nav-icon">üìà</span>
            <span>Resumen</span>
        </button>
    </nav>

    <!-- MODALES -->
    
    <!-- Modal Calculadora -->
    <div id="modal-calculator" class="modal-overlay">
        <div class="modal-content">
            <h3 class="text-xl font-bold text-blue-400 mb-4">üßÆ Calculadora</h3>
            <div class="calculator">
                <div class="calc-display" id="calc-display">0</div>
                <div class="calc-buttons">
                    <button class="calc-btn clear" onclick="calcClear()">C</button>
                    <button class="calc-btn" onclick="calcBackspace()">‚å´</button>
                    <button class="calc-btn operator" onclick="calcAppend('/')">√∑</button>
                    <button class="calc-btn operator" onclick="calcAppend('*')">√ó</button>
                    
                    <button class="calc-btn" onclick="calcAppend('7')">7</button>
                    <button class="calc-btn" onclick="calcAppend('8')">8</button>
                    <button class="calc-btn" onclick="calcAppend('9')">9</button>
                    <button class="calc-btn operator" onclick="calcAppend('-')">-</button>
                    
                    <button class="calc-btn" onclick="calcAppend('4')">4</button>
                    <button class="calc-btn" onclick="calcAppend('5')">5</button>
                    <button class="calc-btn" onclick="calcAppend('6')">6</button>
                    <button class="calc-btn operator" onclick="calcAppend('+')">+</button>
                    
                    <button class="calc-btn" onclick="calcAppend('1')">1</button>
                    <button class="calc-btn" onclick="calcAppend('2')">2</button>
                    <button class="calc-btn" onclick="calcAppend('3')">3</button>
                    <button class="calc-btn" onclick="calcAppend('.')">.</button>
                    
                    <button class="calc-btn" onclick="calcAppend('0')">0</button>
                    <button class="calc-btn equals" onclick="calcEquals()">OK</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal Editar Registro -->
    <div id="modal-edit-registro" class="modal-overlay">
        <div class="modal-content">
            <h3 class="text-xl font-bold text-blue-400 mb-4">‚úèÔ∏è Editar Registro</h3>
            <form onsubmit="updateRegistro(event)">
                <label>üí∞ Tipo</label>
                <select id="edit-reg-tipo">
                    <option value="Ingreso">üü¢ Ingreso</option>
                    <option value="Gasto">üî¥ Gasto</option>
                </select>
                
                <label>üìÖ Fecha</label>
                <input type="date" id="edit-reg-fecha">
                
                <label>üíµ Monto</label>
                <div class="flex gap-2">
                    <input type="number" id="edit-reg-monto" step="0.01" class="flex-1">
                    <button type="button" onclick="openCalculator('edit-reg-monto')" class="bg-blue-500 text-white px-4 rounded-lg">
                        <i data-lucide="calculator" class="w-5 h-5"></i>
                    </button>
                </div>
                
                <label>üè∑Ô∏è Categor√≠a</label>
                <select id="edit-reg-categoria"></select>
                
                <label>üìÑ Detalle</label>
                <textarea id="edit-reg-detalle"></textarea>
                
                <div class="flex gap-2 mt-4">
                    <button type="button" onclick="closeModal('modal-edit-registro')" class="btn-secondary flex-1">
                        Cancelar
                    </button>
                    <button type="submit" class="btn-primary flex-1">
                        <i data-lucide="save" class="w-5 h-5"></i>
                        Guardar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Editar Viaje -->
    <div id="modal-edit-viaje" class="modal-overlay">
        <div class="modal-content">
            <h3 class="text-xl font-bold text-blue-400 mb-4">‚úèÔ∏è Editar Viaje</h3>
            <form onsubmit="updateViaje(event)">
                <label>üìÖ Fecha</label>
                <input type="date" id="edit-viaje-fecha">
                
                <label>üë§ Cliente</label>
                <input type="text" id="edit-viaje-cliente">
                
                <label>üìç Origen</label>
                <input type="text" id="edit-viaje-inicio">
                
                <label>üéØ Destino</label>
                <input type="text" id="edit-viaje-fin">
                
                <label>üíµ Monto</label>
                <div class="flex gap-2">
                    <input type="number" id="edit-viaje-monto" step="0.01" class="flex-1">
                    <button type="button" onclick="openCalculator('edit-viaje-monto')" class="bg-blue-500 text-white px-4 rounded-lg">
                        <i data-lucide="calculator" class="w-5 h-5"></i>
                    </button>
                </div>
                
                <label>üìã Estado</label>
                <select id="edit-viaje-estado">
                    <option value="Cotizaci√≥n">üìÑ Cotizaci√≥n</option>
                    <option value="Programado">üìÖ Programado</option>
                    <option value="Realizado">‚úÖ Realizado</option>
                </select>
                
                <label>üìù Condici√≥n</label>
                <input type="text" id="edit-viaje-condicion">
                
                <label>üìÑ Detalle</label>
                <textarea id="edit-viaje-detalle"></textarea>
                
                <div class="flex gap-2 mt-4">
                    <button type="button" onclick="closeModal('modal-edit-viaje')" class="btn-secondary flex-1">
                        Cancelar
                    </button>
                    <button type="submit" class="btn-primary flex-1">
                        <i data-lucide="save" class="w-5 h-5"></i>
                        Guardar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Filtros -->
    <div id="modal-filtros" class="modal-overlay">
        <div class="modal-content">
            <h3 class="text-xl font-bold text-blue-400 mb-4">üîç Filtros Avanzados</h3>
            <label>üè∑Ô∏è Categor√≠a</label>
            <select id="filter-categoria">
                <option value="">Todas</option>
            </select>
            
            <label>üí∞ Tipo</label>
            <select id="filter-tipo">
                <option value="">Todos</option>
                <option value="Ingreso">üü¢ Ingreso</option>
                <option value="Gasto">üî¥ Gasto</option>
            </select>
            
            <label>üîé Buscar en detalle</label>
            <input type="text" id="filter-texto" placeholder="Palabras clave...">
            
            <div class="flex gap-2 mt-4">
                <button onclick="clearFilters()" class="btn-secondary flex-1">
                    üîÑ Limpiar
                </button>
                <button onclick="applyFilters()" class="btn-primary flex-1">
                    ‚úÖ Aplicar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Nueva Categor√≠a -->
    <div id="modal-nueva-categoria" class="modal-overlay">
        <div class="modal-content">
            <h3 class="text-lg font-bold text-blue-400 mb-4">‚ûï Nueva Categor√≠a</h3>
            <input type="text" id="nueva-categoria-nombre" placeholder="Nombre de la categor√≠a">
            <div class="flex gap-2 mt-4">
                <button onclick="closeModal('modal-nueva-categoria')" class="btn-secondary flex-1">
                    Cancelar
                </button>
                <button onclick="saveNuevaCategoria()" class="btn-primary flex-1">
                    A√±adir
                </button>
            </div>
        </div>
    </div>

    <script>
        // VARIABLES GLOBALES
        let registros = [];
        let viajes = [];
        let diezmos = [];
        let categorias = ["Sueldo", "Ventas", "Transporte", "Comida", "Vivienda", "Salud", "Uber Diario", "Renta Carro", "Mantenimiento", "Internet", "Gasolina", "Privado"];
        let currentSection = 'inicio';
        let editingId = null;
        let currentFilters = {};
        let navigationHistory = ['welcome'];
        let calcTargetInput = null;
        let calcExpression = '';

        const formatter = new Intl.NumberFormat('es-GT', { 
            style: 'currency', 
            currency: 'GTQ',
            minimumFractionDigits: 2
        });

        // NAVEGACI√ìN DEL NAVEGADOR
        window.addEventListener('popstate', function(event) {
            if (navigationHistory.length > 1) {
                navigationHistory.pop();
                const prev = navigationHistory[navigationHistory.length - 1];
                if (prev === 'welcome') {
                    document.getElementById('welcome').style.display = 'flex';
                } else {
                    nav(prev, false);
                }
            }
        });

        function closeWelcome() {
            document.getElementById('welcome').style.display = 'none';
            history.pushState({section: 'inicio'}, '', '');
            navigationHistory.push('inicio');
            loadData();
            updateHomeResumen();
        }

        function nav(section, addToHistory = true) {
            currentSection = section;
            
            document.querySelectorAll('main > section').forEach(s => s.classList.add('hidden'));
            document.getElementById('sec-' + section).classList.remove('hidden');
            
            const titles = {
                'inicio': 'INICIO',
                'registros': 'NUEVO REGISTRO',
                'historial-registros': 'HISTORIAL',
                'viajes': 'NUEVO VIAJE',
                'historial-viajes': 'RUTAS',
                'diezmos': 'DIEZMOS',
                'historial-diezmos': 'PAGOS',
                'resumen': 'RESUMEN'
            };
            document.getElementById('section-title').textContent = titles[section] || 'LARA';
            
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('nav-active'));
            const navBtn = document.getElementById('n-' + section);
            if (navBtn) navBtn.classList.add('nav-active');
            
            const fabSections = ['historial-registros', 'historial-viajes'];
            const fab = document.getElementById('fab');
            if (fabSections.includes(section)) {
                fab.classList.remove('hidden');
            } else {
                fab.classList.add('hidden');
            }
            
            if (section === 'inicio') updateHomeResumen();
            if (section === 'registros') {
                renderCategoriasSelect();
                document.getElementById('reg-fecha').valueAsDate = new Date();
            }
            if (section === 'historial-registros') renderRegistrosList();
            if (section === 'viajes') document.getElementById('viaje-fecha').valueAsDate = new Date();
            if (section === 'historial-viajes') renderViajesList();
            if (section === 'diezmos') initDiezmos();
            if (section === 'historial-diezmos') renderDiezmosList();
            if (section === 'resumen') renderResumen();
            
            lucide.createIcons();
            
            if (addToHistory) {
                history.pushState({section: section}, '', '');
                navigationHistory.push(section);
            }
        }

        // TEMA
        function toggleTheme() {
            const body = document.body;
            const isLight = body.getAttribute('data-theme') === 'light';
            
            if (isLight) {
                body.removeAttribute('data-theme');
                localStorage.setItem('theme', 'dark');
            } else {
                body.setAttribute('data-theme', 'light');
                localStorage.setItem('theme', 'light');
            }
            lucide.createIcons();
        }

        // NOTIFICACIONES
        function showNotification(message, type = 'success') {
            const notif = document.getElementById('notification');
            notif.textContent = message;
            notif.style.backgroundColor = type === 'success' ? '#10b981' : '#ef4444';
            notif.classList.add('show');
            setTimeout(() => {
                notif.classList.remove('show');
            }, 2500);
        }

        // INDICADOR DE SINCRONIZACI√ìN
        function showSyncIndicator(status = 'syncing') {
            const indicator = document.getElementById('sync-indicator');
            const text = document.getElementById('sync-text');
            const icon = indicator.querySelector('i');
            
            indicator.className = 'sync-indicator';
            
            if (status === 'syncing') {
                indicator.classList.add('syncing');
                text.textContent = 'Sincronizando...';
                icon.setAttribute('data-lucide', 'cloud');
                icon.classList.add('spinning');
            } else if (status === 'success') {
                indicator.style.display = 'flex';
                indicator.style.background = 'rgba(16, 185, 129, 0.9)';
                text.textContent = 'Sincronizado';
                icon.setAttribute('data-lucide', 'cloud-check');
                icon.classList.remove('spinning');
                setTimeout(() => {
                    indicator.style.display = 'none';
                }, 2000);
            } else if (status === 'error') {
                indicator.classList.add('error');
                text.textContent = 'Error al sincronizar';
                icon.setAttribute('data-lucide', 'cloud-off');
                icon.classList.remove('spinning');
                setTimeout(() => {
                    indicator.style.display = 'none';
                }, 3000);
            }
            
            lucide.createIcons();
        }

        // MODALES
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
            editingId = null;
        }

        function openModal() {
            if (currentSection === 'historial-registros') {
                nav('registros');
            } else if (currentSection === 'historial-viajes') {
                nav('viajes');
            }
        }

        // CALCULADORA
        function openCalculator(targetInputId) {
            calcTargetInput = targetInputId;
            calcExpression = document.getElementById(targetInputId).value || '0';
            document.getElementById('calc-display').textContent = calcExpression;
            document.getElementById('modal-calculator').classList.add('show');
        }

        function calcAppend(value) {
            if (calcExpression === '0' && value !== '.') {
                calcExpression = value;
            } else {
                calcExpression += value;
            }
            document.getElementById('calc-display').textContent = calcExpression;
        }

        function calcClear() {
            calcExpression = '0';
            document.getElementById('calc-display').textContent = calcExpression;
        }

        function calcBackspace() {
            calcExpression = calcExpression.slice(0, -1) || '0';
            document.getElementById('calc-display').textContent = calcExpression;
        }

        function calcEquals() {
            try {
                const result = eval(calcExpression);
                document.getElementById(calcTargetInput).value = result.toFixed(2);
                closeModal('modal-calculator');
                calcExpression = '0';
            } catch (error) {
                showNotification('‚ùå Expresi√≥n inv√°lida', 'error');
            }
        }

        // ALMACENAMIENTO
        function saveData() {
            try {
                localStorage.setItem('lara_registros', JSON.stringify(registros));
                localStorage.setItem('lara_viajes', JSON.stringify(viajes));
                localStorage.setItem('lara_diezmos', JSON.stringify(diezmos));
                localStorage.setItem('lara_categorias', JSON.stringify(categorias));
                
                showSyncIndicator('success');
            } catch (error) {
                console.error('Error al guardar:', error);
                showSyncIndicator('error');
            }
        }

        function loadData() {
            registros = JSON.parse(localStorage.getItem('lara_registros') || '[]');
            viajes = JSON.parse(localStorage.getItem('lara_viajes') || '[]');
            diezmos = JSON.parse(localStorage.getItem('lara_diezmos') || '[]');
            const loadedCats = JSON.parse(localStorage.getItem('lara_categorias') || '[]');
            if (loadedCats.length > 0) categorias = loadedCats;
        }

        // FUNCIONES DE FORMATO
        function formatQ(n) {
            return formatter.format(n).replace('GTQ', 'Q');
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr + 'T00:00:00');
            return date.toLocaleDateString('es-MX', { day: '2-digit', month: 'short', year: 'numeric' });
        }

        // CATEGOR√çAS
        function renderCategoriasSelect() {
            const select = document.getElementById('reg-categoria');
            select.innerHTML = categorias.map(c => `<option value="${c}">${c}</option>`).join('') +
                '<option value="__nuevo__">‚ûï Agregar Nueva</option>';
            
            select.onchange = function() {
                if (this.value === '__nuevo__') {
                    document.getElementById('modal-nueva-categoria').classList.add('show');
                    this.value = categorias[0];
                }
            };
        }

        function saveNuevaCategoria() {
            const nombre = document.getElementById('nueva-categoria-nombre').value.trim();
            if (nombre && !categorias.includes(nombre)) {
                categorias.push(nombre);
                saveData();
                renderCategoriasSelect();
                document.getElementById('reg-categoria').value = nombre;
                showNotification('‚úÖ Categor√≠a agregada');
            }
            closeModal('modal-nueva-categoria');
            document.getElementById('nueva-categoria-nombre').value = '';
        }

        // REGISTROS
        function saveRegistro() {
            const tipo = document.getElementById('reg-tipo').value;
            const fecha = document.getElementById('reg-fecha').value;
            const monto = parseFloat(document.getElementById('reg-monto').value);
            const categoria = document.getElementById('reg-categoria').value;
            const detalle = document.getElementById('reg-detalle').value.trim();
            
            if (!fecha || isNaN(monto) || monto <= 0) {
                showNotification('‚ùå Completa todos los campos obligatorios', 'error');
                return;
            }
            
            showSyncIndicator('syncing');
            
            registros.push({
                id: Date.now(),
                tipo,
                fecha,
                monto,
                categoria,
                detalle,
                created: Date.now()
            });
            
            saveData();
            showNotification('‚úÖ Registro guardado');
            
            document.getElementById('reg-monto').value = '';
            document.getElementById('reg-detalle').value = '';
        }

        function renderRegistrosList() {
            const container = document.getElementById('registros-list');
            
            let filtered = registros.slice();
            
            const desde = document.getElementById('filter-fecha-desde').value;
            const hasta = document.getElementById('filter-fecha-hasta').value;
            if (desde) filtered = filtered.filter(r => r.fecha >= desde);
            if (hasta) filtered = filtered.filter(r => r.fecha <= hasta);
            
            if (currentFilters.categoria) filtered = filtered.filter(r => r.categoria === currentFilters.categoria);
            if (currentFilters.tipo) filtered = filtered.filter(r => r.tipo === currentFilters.tipo);
            if (currentFilters.texto) {
                const texto = currentFilters.texto.toLowerCase();
                filtered = filtered.filter(r => (r.detalle || '').toLowerCase().includes(texto));
            }
            
            filtered.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
            
            if (filtered.length === 0) {
                container.innerHTML = '<div class="card text-center text-slate-400">No hay registros</div>';
                return;
            }
            
            container.innerHTML = filtered.map((r, idx) => {
                const color = r.tipo === 'Ingreso' ? 'text-emerald-400' : 'text-red-400';
                const sign = r.tipo === 'Ingreso' ? '+' : '-';
                return `
                    <div class="card clickable" onclick="editRegistro(${r.id})">
                        <div class="flex items-center gap-3">
                            <div class="flex-1">
                                <p class="text-xs font-bold text-slate-500 mb-1">#${idx + 1} | ${r.categoria}</p>
                                <p class="text-sm font-bold ${color}">${r.tipo}</p>
                                <p class="text-xs text-slate-400">${formatDate(r.fecha)}</p>
                                <p class="text-xs text-slate-500">${r.detalle || 'Sin notas'}</p>
                            </div>
                            <div class="text-right">
                                <p class="text-xl font-black ${color}">${sign}${formatQ(r.monto)}</p>
                                <button onclick="deleteRegistro(${r.id}, event)" class="text-red-400 mt-2">
                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            lucide.createIcons();
        }

        function editRegistro(id) {
            const reg = registros.find(r => r.id === id);
            if (!reg) return;
            
            editingId = id;
            
            const modal = document.getElementById('modal-edit-registro');
            document.getElementById('edit-reg-tipo').value = reg.tipo;
            document.getElementById('edit-reg-fecha').value = reg.fecha;
            document.getElementById('edit-reg-monto').value = reg.monto;
            
            const catSelect = document.getElementById('edit-reg-categoria');
            catSelect.innerHTML = categorias.map(c => 
                `<option value="${c}" ${c === reg.categoria ? 'selected' : ''}>${c}</option>`
            ).join('');
            
            document.getElementById('edit-reg-detalle').value = reg.detalle || '';
            
            modal.classList.add('show');
            lucide.createIcons();
        }

        function updateRegistro(event) {
            event.preventDefault();
            
            const idx = registros.findIndex(r => r.id === editingId);
            if (idx === -1) return;
            
            showSyncIndicator('syncing');
            
            registros[idx] = {
                ...registros[idx],
                tipo: document.getElementById('edit-reg-tipo').value,
                fecha: document.getElementById('edit-reg-fecha').value,
                monto: parseFloat(document.getElementById('edit-reg-monto').value),
                categoria: document.getElementById('edit-reg-categoria').value,
                detalle: document.getElementById('edit-reg-detalle').value.trim()
            };
            
            saveData();
            closeModal('modal-edit-registro');
            renderRegistrosList();
            showNotification('‚úÖ Registro actualizado');
        }

        function deleteRegistro(id, event) {
            event.stopPropagation();
            if (confirm('¬øEliminar este registro?')) {
                showSyncIndicator('syncing');
                registros = registros.filter(r => r.id !== id);
                saveData();
                renderRegistrosList();
                showNotification('üóëÔ∏è Registro eliminado');
            }
        }

        // VIAJES
        function saveViaje() {
            const fecha = document.getElementById('viaje-fecha').value;
            const cliente = document.getElementById('viaje-cliente').value.trim();
            const inicio = document.getElementById('viaje-inicio').value.trim();
            const fin = document.getElementById('viaje-fin').value.trim();
            const monto = parseFloat(document.getElementById('viaje-monto').value) || 0;
            const estado = document.getElementById('viaje-estado').value;
            const condicion = document.getElementById('viaje-condicion').value.trim();
            const detalle = document.getElementById('viaje-detalle').value.trim();
            
            if (!fecha || !cliente || !inicio || !fin) {
                showNotification('‚ùå Completa los campos obligatorios', 'error');
                return;
            }
            
            showSyncIndicator('syncing');
            
            viajes.push({
                id: Date.now(),
                fecha,
                cliente,
                inicio,
                fin,
                monto,
                estado,
                condicion,
                detalle,
                created: Date.now()
            });
            
            saveData();
            showNotification('‚úÖ Viaje guardado');
            
            document.getElementById('viaje-cliente').value = '';
            document.getElementById('viaje-inicio').value = '';
            document.getElementById('viaje-fin').value = '';
            document.getElementById('viaje-monto').value = '';
            document.getElementById('viaje-condicion').value = '';
            document.getElementById('viaje-detalle').value = '';
        }

        function renderViajesList() {
            const container = document.getElementById('viajes-list');
            
            if (viajes.length === 0) {
                container.innerHTML = '<div class="card text-center text-slate-400">No hay viajes registrados</div>';
                return;
            }
            
            const sorted = viajes.slice().sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
            
            container.innerHTML = sorted.map((v, idx) => {
                const color = v.estado === 'Realizado' ? 'text-emerald-400' : 'text-blue-400';
                return `
                    <div class="card clickable" onclick="editViaje(${v.id})">
                        <div class="flex items-center gap-3">
                            <div class="flex-1">
                                <p class="text-xs font-bold text-slate-500 mb-1">#${idx + 1} | ${v.cliente}</p>
                                <p class="text-sm font-bold">${v.inicio} ‚Üí ${v.fin}</p>
                                <p class="text-xs text-slate-400">${formatDate(v.fecha)} - <span class="${color}">${v.estado}</span></p>
                                ${v.condicion ? `<p class="text-xs text-blue-300 mt-1">üìù ${v.condicion}</p>` : ''}
                            </div>
                            <div class="text-right">
                                <p class="text-xl font-black ${color}">${v.monto > 0 ? formatQ(v.monto) : '---'}</p>
                                <button onclick="deleteViaje(${v.id}, event)" class="text-red-400 mt-2">
                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            lucide.createIcons();
        }

        function editViaje(id) {
            const viaje = viajes.find(v => v.id === id);
            if (!viaje) return;
            
            editingId = id;
            
            document.getElementById('edit-viaje-fecha').value = viaje.fecha;
            document.getElementById('edit-viaje-cliente').value = viaje.cliente;
            document.getElementById('edit-viaje-inicio').value = viaje.inicio;
            document.getElementById('edit-viaje-fin').value = viaje.fin;
            document.getElementById('edit-viaje-monto').value = viaje.monto || '';
            document.getElementById('edit-viaje-estado').value = viaje.estado;
            document.getElementById('edit-viaje-condicion').value = viaje.condicion || '';
            document.getElementById('edit-viaje-detalle').value = viaje.detalle || '';
            
            document.getElementById('modal-edit-viaje').classList.add('show');
            lucide.createIcons();
        }

        function updateViaje(event) {
            event.preventDefault();
            
            const idx = viajes.findIndex(v => v.id === editingId);
            if (idx === -1) return;
            
            showSyncIndicator('syncing');
            
            viajes[idx] = {
                ...viajes[idx],
                fecha: document.getElementById('edit-viaje-fecha').value,
                cliente: document.getElementById('edit-viaje-cliente').value.trim(),
                inicio: document.getElementById('edit-viaje-inicio').value.trim(),
                fin: document.getElementById('edit-viaje-fin').value.trim(),
                monto: parseFloat(document.getElementById('edit-viaje-monto').value) || 0,
                estado: document.getElementById('edit-viaje-estado').value,
                condicion: document.getElementById('edit-viaje-condicion').value.trim(),
                detalle: document.getElementById('edit-viaje-detalle').value.trim()
            };
            
            saveData();
            closeModal('modal-edit-viaje');
            renderViajesList();
            showNotification('‚úÖ Viaje actualizado');
        }

        function deleteViaje(id, event) {
            event.stopPropagation();
            if (confirm('¬øEliminar este viaje?')) {
                showSyncIndicator('syncing');
                viajes = viajes.filter(v => v.id !== id);
                saveData();
                renderViajesList();
                showNotification('üóëÔ∏è Viaje eliminado');
            }
        }

        // DIEZMOS
        function getQuincenaRange(monthStr, q) {
            const [y, m] = monthStr.split('-').map(Number);
            const start = new Date(y, m - 1, q == 1 ? 1 : 16);
            start.setHours(0, 0, 0, 0);
            
            const end = q == 1 ? 
                new Date(y, m - 1, 15, 23, 59, 59) : 
                new Date(y, m, 0, 23, 59, 59);
            
            return { start, end };
        }

        function initDiezmos() {
            const hoy = new Date();
            document.getElementById('diezmo-month').value = hoy.toISOString().slice(0, 7);
            document.getElementById('diezmo-quincena').value = hoy.getDate() <= 15 ? '1' : '2';
            calcularDiezmo();
        }

        function calcularDiezmo() {
            const month = document.getElementById('diezmo-month').value;
            const q = document.getElementById('diezmo-quincena').value;
            const { start, end } = getQuincenaRange(month, q);
            const key = `${month}-q${q}`;
            
            let ing = 0, gas = 0;
            registros.forEach(r => {
                const d = new Date(r.fecha + 'T00:00:00');
                if (d >= start && d <= end) {
                    if (r.tipo === 'Ingreso') ing += r.monto;
                    else gas += r.monto;
                }
            });
            
            const base = Math.max(0, ing - gas);
            const sugerido = base * 0.10;
            
            const pagado = diezmos
                .filter(d => d.quincenaKey === key)
                .reduce((sum, d) => sum + d.monto, 0);
            
            const faltante = Math.max(0, sugerido - pagado);
            
            document.getElementById('diezmo-info').innerHTML = `
                <h3 class="text-sm font-bold text-blue-400 mb-3 uppercase">
                    üíö Quincena: ${start.getDate()} - ${end.getDate()} de ${start.toLocaleDateString('es-MX', { month: 'long', year: 'numeric' })}
                </h3>
                <div class="space-y-2 text-sm">
                    <div class="flex justify-between border-b border-white/10 pb-2">
                        <span>üí∞ Ingresos:</span>
                        <b class="text-emerald-400">${formatQ(ing)}</b>
                    </div>
                    <div class="flex justify-between border-b border-white/10 pb-2">
                        <span>üí∏ Gastos:</span>
                        <b class="text-red-400">${formatQ(gas)}</b>
                    </div>
                    <div class="flex justify-between border-b border-white/10 pb-2">
                        <span>üìä Base (Neta):</span>
                        <b>${formatQ(base)}</b>
                    </div>
                    <div class="flex justify-between border-t-2 border-blue-500/30 pt-2">
                        <span class="font-bold">üíé Diezmo Sugerido (10%):</span>
                        <b class="text-xl text-blue-400">${formatQ(sugerido)}</b>
                    </div>
                    <div class="flex justify-between border-b border-white/10 pb-2">
                        <span>‚úÖ Pagado:</span>
                        <b class="text-emerald-400">${formatQ(pagado)}</b>
                    </div>
                    <div class="flex justify-between border-t-2 border-red-500/30 pt-2">
                        <span class="font-bold text-red-400">‚ö†Ô∏è FALTANTE:</span>
                        <b class="text-xl text-red-400">${formatQ(faltante)}</b>
                    </div>
                </div>
            `;
            
            document.getElementById('diezmo-monto').value = faltante > 0 ? faltante.toFixed(2) : '';
        }

        function saveDiezmo() {
            const month = document.getElementById('diezmo-month').value;
            const q = document.getElementById('diezmo-quincena').value;
            const monto = parseFloat(document.getElementById('diezmo-monto').value);
            const metodo = document.getElementById('diezmo-metodo').value;
            
            if (isNaN(monto) || monto <= 0) {
                showNotification('‚ùå Ingresa un monto v√°lido', 'error');
                return;
            }
            
            showSyncIndicator('syncing');
            
            diezmos.push({
                id: Date.now(),
                quincenaKey: `${month}-q${q}`,
                fecha: new Date().toISOString().split('T')[0],
                monto,
                metodo,
                created: Date.now()
            });
            
            saveData();
            calcularDiezmo();
            document.getElementById('diezmo-monto').value = '';
            showNotification('üôè Pago de diezmo registrado');
        }

        function renderDiezmosList() {
            const container = document.getElementById('diezmos-list');
            
            if (diezmos.length === 0) {
                container.innerHTML = '<div class="card text-center text-slate-400">No hay pagos registrados</div>';
                return;
            }
            
            const grouped = {};
            diezmos.forEach(d => {
                if (!grouped[d.quincenaKey]) grouped[d.quincenaKey] = [];
                grouped[d.quincenaKey].push(d);
            });
            
            const keys = Object.keys(grouped).sort().reverse();
            
            container.innerHTML = keys.map(key => {
                const pagos = grouped[key].sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
                const total = pagos.reduce((sum, p) => sum + p.monto, 0);
                
                const [monthStr, qStr] = key.split('-q');
                const q = parseInt(qStr);
                const { start, end } = getQuincenaRange(monthStr, q);
                
                return `
                    <div class="card">
                        <div class="flex justify-between items-center mb-3 pb-3 border-b border-white/10">
                            <div>
                                <p class="font-bold text-sm">Quincena ${q}: ${start.getDate()}-${end.getDate()} ${start.toLocaleDateString('es-MX', { month: 'short', year: 'numeric' })}</p>
                                <p class="text-xs text-slate-400">${pagos.length} pago(s)</p>
                            </div>
                            <p class="text-lg font-black text-emerald-400">${formatQ(total)}</p>
                        </div>
                        <div class="space-y-2">
                            ${pagos.map(p => `
                                <div class="flex justify-between items-center text-sm bg-white/5 p-2 rounded-lg">
                                    <div class="flex-1">
                                        <p class="text-xs text-slate-400">${formatDate(p.fecha)} ‚Ä¢ ${p.metodo}</p>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <span class="font-bold text-emerald-400">${formatQ(p.monto)}</span>
                                        <button onclick="deleteDiezmo(${p.id})" class="text-red-400">
                                            <i data-lucide="x-circle" class="w-4 h-4"></i>
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }).join('');
            
            lucide.createIcons();
        }

        function deleteDiezmo(id) {
            if (confirm('¬øEliminar este pago?')) {
                showSyncIndicator('syncing');
                diezmos = diezmos.filter(d => d.id !== id);
                saveData();
                renderDiezmosList();
                if (currentSection === 'diezmos') calcularDiezmo();
                showNotification('üóëÔ∏è Pago eliminado');
            }
        }

        // FILTROS
        function showFilterModal() {
            const modal = document.getElementById('modal-filtros');
            const catSelect = document.getElementById('filter-categoria');
            catSelect.innerHTML = '<option value="">Todas</option>' + 
                categorias.map(c => `<option value="${c}" ${currentFilters.categoria === c ? 'selected' : ''}>${c}</option>`).join('');
            
            document.getElementById('filter-tipo').value = currentFilters.tipo || '';
            document.getElementById('filter-texto').value = currentFilters.texto || '';
            
            modal.classList.add('show');
        }

        function applyFilters() {
            currentFilters = {
                categoria: document.getElementById('filter-categoria').value,
                tipo: document.getElementById('filter-tipo').value,
                texto: document.getElementById('filter-texto').value.toLowerCase()
            };
            closeModal('modal-filtros');
            renderRegistrosList();
        }

        function clearFilters() {
            currentFilters = {};
            document.getElementById('filter-fecha-desde').value = '';
            document.getElementById('filter-fecha-hasta').value = '';
            closeModal('modal-filtros');
            renderRegistrosList();
        }

        function applyQuickFilters() {
            renderRegistrosList();
        }

        // RESUMEN
        function updateHomeResumen() {
            const hoy = new Date();
            const start = new Date(hoy.getFullYear(), hoy.getMonth(), 1);
            const end = new Date(hoy.getFullYear(), hoy.getMonth() + 1, 0, 23, 59, 59);
            
            let ing = 0, gas = 0;
            registros.forEach(r => {
                const d = new Date(r.fecha + 'T00:00:00');
                if (d >= start && d <= end) {
                    if (r.tipo === 'Ingreso') ing += r.monto;
                    else gas += r.monto;
                }
            });
            
            const neto = ing - gas;
            document.getElementById('home-neto').textContent = formatQ(neto);
            document.getElementById('home-ingresos').textContent = formatQ(ing);
            document.getElementById('home-gastos').textContent = formatQ(gas);
        }

        function renderResumen() {
            const container = document.getElementById('resumen-container');
            
            const hoy = new Date();
            const start = new Date(hoy.getFullYear(), hoy.getMonth(), 1);
            const end = new Date(hoy.getFullYear(), hoy.getMonth() + 1, 0, 23, 59, 59);
            
            let ingMes = 0, gasMes = 0;
            registros.forEach(r => {
                const d = new Date(r.fecha + 'T00:00:00');
                if (d >= start && d <= end) {
                    if (r.tipo === 'Ingreso') ingMes += r.monto;
                    else gasMes += r.monto;
                }
            });
            
            const netoMes = ingMes - gasMes;
            
            let ingTotal = 0, gasTotal = 0;
            registros.forEach(r => {
                if (r.tipo === 'Ingreso') ingTotal += r.monto;
                else gasTotal += r.monto;
            });
            const netoTotal = ingTotal - gasTotal;
            
            const catStats = {};
            registros.forEach(r => {
                if (!catStats[r.categoria]) catStats[r.categoria] = { ing: 0, gas: 0 };
                if (r.tipo === 'Ingreso') catStats[r.categoria].ing += r.monto;
                else catStats[r.categoria].gas += r.monto;
            });
            
            const monthStats = {};
            registros.forEach(r => {
                const key = r.fecha.slice(0, 7);
                if (!monthStats[key]) monthStats[key] = { ing: 0, gas: 0 };
                if (r.tipo === 'Ingreso') monthStats[key].ing += r.monto;
                else monthStats[key].gas += r.monto;
            });
            
            let html = `
                <div class="card bg-gradient-to-br from-blue-600 to-blue-700 border-0">
                    <p class="text-blue-100 text-xs font-bold uppercase mb-1">üí∞ Mes Actual (${hoy.toLocaleDateString('es-MX', { month: 'long', year: 'numeric' })})</p>
                    <h2 class="text-4xl font-black text-white mb-4">${formatQ(netoMes)}</h2>
                    <div class="grid grid-cols-2 gap-3">
                        <div class="bg-white/10 backdrop-blur p-3 rounded-xl">
                            <p class="text-xs text-blue-100 uppercase font-bold">Ingresos</p>
                            <p class="text-lg font-bold text-white">${formatQ(ingMes)}</p>
                        </div>
                        <div class="bg-white/10 backdrop-blur p-3 rounded-xl">
                            <p class="text-xs text-blue-100 uppercase font-bold">Gastos</p>
                            <p class="text-lg font-bold text-white">${formatQ(gasMes)}</p>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <h3 class="text-sm font-bold text-blue-400 mb-3 uppercase">üìä Totales Globales</h3>
                    <div class="text-center mb-3">
                        <p class="text-xs text-slate-400 uppercase">Ganancia Neta Total</p>
                        <p class="text-3xl font-black ${netoTotal >= 0 ? 'text-emerald-400' : 'text-red-400'}">${formatQ(netoTotal)}</p>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div class="bg-emerald-500/10 p-3 rounded-xl text-center">
                            <p class="text-xs text-emerald-400 font-bold">Ingresos</p>
                            <p class="text-lg font-bold text-emerald-400">${formatQ(ingTotal)}</p>
                        </div>
                        <div class="bg-red-500/10 p-3 rounded-xl text-center">
                            <p class="text-xs text-red-400 font-bold">Gastos</p>
                            <p class="text-lg font-bold text-red-400">${formatQ(gasTotal)}</p>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <h3 class="text-sm font-bold text-blue-400 mb-3 uppercase">üè∑Ô∏è Por Categor√≠a</h3>
                    <div class="space-y-2">
                        ${Object.keys(catStats).map(cat => {
                            const neto = catStats[cat].ing - catStats[cat].gas;
                            const color = neto >= 0 ? 'text-emerald-400' : 'text-red-400';
                            return `
                                <div class="flex justify-between items-center border-b border-white/5 pb-2">
                                    <div class="flex-1">
                                        <p class="font-bold text-sm">${cat}</p>
                                        <p class="text-xs text-slate-400">I: ${formatQ(catStats[cat].ing)} | G: ${formatQ(catStats[cat].gas)}</p>
                                    </div>
                                    <p class="font-black ${color}">${formatQ(neto)}</p>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
                
                <div class="card">
                    <h3 class="text-sm font-bold text-blue-400 mb-3 uppercase">üìÖ Historial Mensual</h3>
                    <div class="space-y-2">
                        ${Object.keys(monthStats).sort().reverse().map(month => {
                            const neto = monthStats[month].ing - monthStats[month].gas;
                            const color = neto >= 0 ? 'text-emerald-400' : 'text-red-400';
                            const date = new Date(month + '-01');
                            const monthName = date.toLocaleDateString('es-MX', { month: 'long', year: 'numeric' });
                            return `
                                <div class="flex justify-between items-center border-b border-white/5 pb-2">
                                    <div class="flex-1">
                                        <p class="font-bold text-sm capitalize">${monthName}</p>
                                        <p class="text-xs text-slate-400">I: ${formatQ(monthStats[month].ing)} | G: ${formatQ(monthStats[month].gas)}</p>
                                    </div>
                                    <p class="font-black ${color}">${formatQ(neto)}</p>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
                
                <div class="card">
                    <h3 class="text-sm font-bold text-blue-400 mb-3 uppercase">üöó Estad√≠sticas de Viajes</h3>
                    <div class="grid grid-cols-3 gap-3">
                        <div class="text-center">
                            <p class="text-xs text-slate-400 uppercase">Total</p>
                            <p class="text-2xl font-black text-blue-400">${viajes.length}</p>
                        </div>
                        <div class="text-center">
                            <p class="text-xs text-slate-400 uppercase">Realizados</p>
                            <p class="text-2xl font-black text-emerald-400">${viajes.filter(v => v.estado === 'Realizado').length}</p>
                        </div>
                        <div class="text-center">
                            <p class="text-xs text-slate-400 uppercase">Pendientes</p>
                            <p class="text-2xl font-black text-orange-400">${viajes.filter(v => v.estado !== 'Realizado').length}</p>
                        </div>
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        }

        // EXPORTAR
        function exportToExcel() {
            if (registros.length === 0) {
                showNotification('‚ùå No hay datos para exportar', 'error');
                return;
            }
            
            const data = registros.map(r => ({
                'Fecha': r.fecha,
                'Tipo': r.tipo,
                'Categor√≠a': r.categoria,
                'Monto': r.monto,
                'Detalle': r.detalle || ''
            }));
            
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Registros');
            
            const fecha = new Date().toISOString().split('T')[0];
            XLSX.writeFile(wb, `LARA_Registros_${fecha}.xlsx`);
            
            showNotification('üìä Datos exportados a Excel');
        }

        function exportPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFontSize(20);
            doc.text('Multi Servicios LARA', 20, 20);
            doc.setFontSize(12);
            doc.text(`Reporte generado: ${new Date().toLocaleDateString('es-MX')}`, 20, 30);
            
            let y = 45;
            doc.setFontSize(14);
            doc.text('Resumen de Registros', 20, y);
            y += 10;
            
            doc.setFontSize(10);
            const sorted = registros.slice().sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
            
            sorted.slice(0, 30).forEach(r => {
                const sign = r.tipo === 'Ingreso' ? '+' : '-';
                const line = `${r.fecha} | ${r.categoria} | ${sign}${formatQ(r.monto)}`;
                doc.text(line, 20, y);
                y += 7;
                
                if (y > 280) {
                    doc.addPage();
                    y = 20;
                }
            });
            
            doc.save(`LARA_Reporte_${new Date().toISOString().split('T')[0]}.pdf`);
            showNotification('üìÑ PDF generado');
        }

        function exportJSON() {
            const data = {
                registros,
                viajes,
                diezmos,
                categorias,
                exportDate: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `LARA_Backup_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            
            showNotification('üíæ Respaldo creado');
        }

        function importJSON(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (data.registros) registros = data.registros;
                    if (data.viajes) viajes = data.viajes;
                    if (data.diezmos) diezmos = data.diezmos;
                    if (data.categorias) categorias = data.categorias;
                    
                    saveData();
                    showNotification('‚úÖ Datos importados correctamente');
                    updateHomeResumen();
                    
                    if (currentSection === 'historial-registros') renderRegistrosList();
                    if (currentSection === 'historial-viajes') renderViajesList();
                    if (currentSection === 'resumen') renderResumen();
                } catch (err) {
                    showNotification('‚ùå Error al importar archivo', 'error');
                    console.error(err);
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        function borrarTodo() {
            if (!confirm('‚ö†Ô∏è ¬øBORRAR TODOS LOS DATOS? Esta acci√≥n NO se puede deshacer.')) return;
            if (!confirm('¬øEst√°s completamente seguro? Se perder√°n TODOS los registros, viajes y pagos.')) return;
            
            localStorage.clear();
            registros = [];
            viajes = [];
            diezmos = [];
            categorias = ["Sueldo", "Ventas", "Transporte", "Comida", "Vivienda", "Salud"];
            
            showNotification('üóëÔ∏è Todos los datos han sido eliminados');
            setTimeout(() => location.reload(), 1500);
        }

        // INICIALIZACI√ìN
        function init() {
            loadData();
            
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'light') {
                document.body.setAttribute('data-theme', 'light');
                document.getElementById('theme-toggle').checked = true;
            }
            
            lucide.createIcons();
            
            const hasVisited = localStorage.getItem('lara_visited');
            if (hasVisited) {
                document.getElementById('welcome').style.display = 'none';
                updateHomeResumen();
            } else {
                localStorage.setItem('lara_visited', 'true');
            }
        }

        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
