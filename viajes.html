<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Viajes - Lara</title>
  <link rel="manifest" href="/Lara/manifest.json" />
  <style>
    :root{--accent:#0b6efd;--muted:#666}
    body{font-family:Inter, system-ui, Arial;margin:0;padding:1rem;background:#f6f9ff;color:#111}
    .wrap{max-width:980px;margin:0 auto}
    header{display:flex;align-items:center;justify-content:space-between}
    .card{background:#fff;padding:1rem;border-radius:12px;box-shadow:0 8px 24px rgba(12,20,55,0.06);margin-top:1rem}
    .row{display:flex;gap:.5rem}
    input,select,textarea{padding:.6rem;border-radius:8px;border:1px solid #e6eef7}
    .btn{background:var(--accent);color:white;border:0;padding:.6rem .9rem;border-radius:10px;cursor:pointer}
    .btn.secondary{background:#666}
    table{width:100%;border-collapse:collapse;margin-top:1rem}
    th,td{padding:.6rem;border-bottom:1px solid #eef4ff;text-align:left}
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.4)}
    .panel{background:white;padding:1rem;border-radius:10px;width:95%;max-width:620px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Viajes</h1>
      <nav>
        <a class="small" href="/Lara/index.html">Inicio</a>
        <a class="small" href="/Lara/registros.html">Registros</a>
        <a class="small" href="/Lara/diezmos.html">Diezmos</a>
      </nav>
    </header>

    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <button id="openNew" class="btn">+ Nuevo viaje</button>
          <button id="exportJson" class="btn secondary">Exportar JSON</button>
          <button id="importJson" class="btn secondary">Importar JSON</button>
          <button id="exportPdf" class="btn">Exportar PDF</button>
          <input id="fileInput" type="file" accept="application/json" style="display:none" />
        </div>
        <div class="small muted">Datos locales</div>
      </div>

      <div style="margin-top:1rem" class="row">
        <div style="flex:1"><label class="small">Desde</label><input id="filterFrom" type="date" /></div>
        <div style="flex:1"><label class="small">Hasta</label><input id="filterTo" type="date" /></div>
        <div style="align-self:end"><button id="applyFilter" class="btn secondary">Aplicar</button></div>
      </div>

      <table id="table">
        <thead><tr><th>Fecha</th><th>Cliente</th><th>Ruta</th><th>Estado</th><th>Condición</th><th>Acciones</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div class="modal" id="modal">
    <div class="panel">
      <h3 id="modalTitle">Nuevo viaje</h3>
      <form id="form">
        <div class="row" style="margin-top:.5rem">
          <input id="fecha" type="date" required style="flex:1" />
          <input id="cliente" placeholder="Cliente" style="flex:1" />
        </div>
        <div class="row" style="margin-top:.5rem">
          <input id="rutaInicio" placeholder="Ruta inicio" style="flex:1" />
          <input id="rutaFin" placeholder="Ruta fin" style="flex:1" />
        </div>
        <div class="row" style="margin-top:.5rem">
          <select id="estado"><option>cotización</option><option>programado</option><option>realizado</option></select>
          <input id="condicion" placeholder="Condición (opcional)" />
        </div>
        <div style="margin-top:.5rem">
          <input id="detalle" placeholder="Detalle" />
        </div>
        <div style="text-align:right;margin-top:.6rem">
          <button type="button" id="cancel" class="btn secondary">Cancelar</button>
          <button type="submit" class="btn">Guardar</button>
        </div>
      </form>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    const KEY = 'viajes_v1';
    let data = JSON.parse(localStorage.getItem(KEY) || '[]');
    const tbody = document.querySelector('#table tbody');
    const modal = document.getElementById('modal');
    const openNew = document.getElementById('openNew');
    const fileInput = document.getElementById('fileInput');
    let editingId = null;

    function render(){
      tbody.innerHTML = '';
      const from = document.getElementById('filterFrom').value ? new Date(document.getElementById('filterFrom').value) : null;
      const to = document.getElementById('filterTo').value ? new Date(document.getElementById('filterTo').value) : null;
      data.slice().sort((a,b)=>b.created-a.created).filter(r=>{
        if(from && new Date(r.fecha) < from) return false;
        if(to && new Date(r.fecha) > to) return false; return true;
      }).forEach(r=>{
        const tr = document.createElement('tr'); tr.innerHTML = `<td>${r.fecha||''}</td><td>${(r.cliente||'')}</td><td>${(r.rutaInicio||'')} → ${(r.rutaFin||'')}</td><td>${r.estado||''}</td><td>${r.condicion||''}</td><td><button data-id="${r.id}" class="btn">Editar</button> <button data-iddel="${r.id}" class="btn secondary">Eliminar</button></td>`;
        tbody.appendChild(tr);
      });
      tbody.querySelectorAll('button[data-id]').forEach(b=>b.addEventListener('click', e=>openEdit(e.currentTarget.dataset.id)));
      tbody.querySelectorAll('button[data-iddel]').forEach(b=>b.addEventListener('click', e=>deleteItem(e.currentTarget.dataset.id)));
    }

    openNew.addEventListener('click', ()=>{ editingId=null; document.getElementById('modalTitle').textContent='Nuevo viaje'; document.getElementById('form').reset(); modal.style.display='flex'; });
    document.getElementById('cancel').addEventListener('click', ()=>modal.style.display='none');

    document.getElementById('form').addEventListener('submit', e=>{
      e.preventDefault();
      const fecha = document.getElementById('fecha').value || new Date().toISOString().slice(0,10);
      const cliente = document.getElementById('cliente').value.trim();
      const rutaInicio = document.getElementById('rutaInicio').value.trim();
      const rutaFin = document.getElementById('rutaFin').value.trim();
      const estado = document.getElementById('estado').value;
      const condicion = document.getElementById('condicion').value.trim();
      const detalle = document.getElementById('detalle').value.trim();
      if(editingId){ const idx = data.findIndex(x=>x.id===editingId); if(idx>-1){ data[idx] = {...data[idx], fecha, cliente, rutaInicio, rutaFin, estado, condicion, detalle}; } }
      else { data.unshift({id:Date.now(), fecha, cliente, rutaInicio, rutaFin, estado, condicion, detalle, created:Date.now()}); }
      localStorage.setItem(KEY, JSON.stringify(data)); modal.style.display='none'; render();
    });

    function openEdit(id){ const item = data.find(x=>String(x.id)===String(id)); if(!item) return; editingId = item.id; document.getElementById('modalTitle').textContent='Editar viaje'; document.getElementById('fecha').value = item.fecha||''; document.getElementById('cliente').value = item.cliente||''; document.getElementById('rutaInicio').value = item.rutaInicio||''; document.getElementById('rutaFin').value = item.rutaFin||''; document.getElementById('estado').value = item.estado||'cotización'; document.getElementById('condicion').value = item.condicion||''; document.getElementById('detalle').value = item.detalle||''; modal.style.display='flex'; }

    function deleteItem(id){ if(!confirm('¿Eliminar viaje?')) return; data = data.filter(x=>String(x.id)!==String(id)); localStorage.setItem(KEY, JSON.stringify(data)); render(); }

    document.getElementById('applyFilter').addEventListener('click', ()=>render());

    // export/import/pdf
    document.getElementById('exportJson').addEventListener('click', ()=>{ const b = new Blob([JSON.stringify(data,null,2)],{type:'application/json'}); const u=URL.createObjectURL(b); const a=document.createElement('a'); a.href=u; a.download='viajes.json'; a.click(); URL.revokeObjectURL(u); });
    document.getElementById('importJson').addEventListener('click', ()=>fileInput.click());
    fileInput.addEventListener('change', e=>{ const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ try{ const imp = JSON.parse(r.result); if(Array.isArray(imp)){ data = [...imp, ...data]; localStorage.setItem(KEY, JSON.stringify(data)); render(); alert('Importado'); } else alert('Formato inválido'); }catch(er){alert('Error:'+er.message)} }; r.readAsText(f); fileInput.value=''; });
    document.getElementById('exportPdf').addEventListener('click', ()=>{ const { jsPDF } = window.jspdf; const doc = new jsPDF(); let y=10; doc.text('Viajes',10,y); y+=8; data.slice(0,200).forEach(r=>{ doc.text(`${r.fecha||''} ${r.cliente||''} ${r.rutaInicio||''} → ${r.rutaFin||''}`,10,y); y+=6; if(r.detalle){ const lines = doc.splitTextToSize(r.detalle,180); doc.text(lines,10,y); y+=lines.length*6; } if(y>280){doc.addPage(); y=10;} }); doc.save('viajes.pdf'); });

    if('serviceWorker' in navigator) navigator.serviceWorker.register('/Lara/sw.js').catch(()=>{});
    render();
  </script>
</body>
</html>