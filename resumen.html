<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lara - Resumen</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lucide/0.263.0/lucide.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root { --primary: #3b82f6; --bg: #f8fafc; }
        body { background-color: var(--bg); font-family: 'Inter', sans-serif; }
        .nav-bar { background: white; border-top: 1px solid #e2e8f0; }
        .nav-btn { display: flex; flex-direction: column; align-items: center; font-size: 0.65rem; color: #94a3b8; flex: 1; padding: 8px 0; }
        .nav-active { color: var(--primary); font-weight: bold; }
    </style>
</head>
<body class="pb-24">

    <header class="p-4 bg-white border-b border-slate-200 sticky top-0 z-30 flex items-center gap-4">
        <a href="/Lara/index.html" class="p-2 text-slate-400"><i data-lucide="arrow-left"></i></a>
        <h1 class="text-xl font-black text-slate-800 uppercase">Resumen Detallado</h1>
    </header>

    <main class="p-4 max-w-md mx-auto space-y-6">
        <!-- Ganancia Total -->
        <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-100 text-center">
            <p class="text-[10px] font-bold text-slate-400 uppercase">Ganancia Neta Total</p>
            <h2 id="total-neto" class="text-4xl font-black text-slate-800">Q.0</h2>
        </div>

        <!-- Desglose por Categorías -->
        <div class="bg-white p-5 rounded-3xl shadow-sm border border-slate-100 space-y-4">
            <h3 class="text-xs font-bold text-slate-400 uppercase">Por Categoría</h3>
            <div id="cat-list" class="space-y-3"></div>
        </div>

        <!-- Historial Mensual -->
        <div class="bg-white p-5 rounded-3xl shadow-sm border border-slate-100 space-y-4">
            <h3 class="text-xs font-bold text-slate-400 uppercase">Historial Mensual</h3>
            <div id="month-list" class="space-y-3"></div>
        </div>

        <!-- Herramientas -->
        <div class="bg-white p-5 rounded-3xl shadow-sm border border-slate-100 space-y-3">
            <h3 class="text-xs font-bold text-slate-400 uppercase">Herramientas</h3>
            <button onclick="exportPDF()" class="w-full bg-slate-800 text-white py-3 rounded-xl font-bold text-sm flex items-center justify-center gap-2">
                <i data-lucide="file-text" class="w-4 h-4"></i> Exportar PDF
            </button>
            <button onclick="exportJSON()" class="w-full bg-slate-100 text-slate-600 py-3 rounded-xl font-bold text-sm flex items-center justify-center gap-2">
                <i data-lucide="download" class="w-4 h-4"></i> Respaldar (JSON)
            </button>
            <input type="file" id="import-file" class="hidden" onchange="importJSON(event)">
            <button onclick="document.getElementById('import-file').click()" class="w-full bg-slate-100 text-slate-600 py-3 rounded-xl font-bold text-sm flex items-center justify-center gap-2">
                <i data-lucide="upload" class="w-4 h-4"></i> Importar Respaldo
            </button>
            <button onclick="clearAll()" class="w-full text-red-400 py-3 font-bold text-xs uppercase tracking-widest">Borrar todos los datos</button>
        </div>
    </main>

    <nav class="nav-bar fixed bottom-0 left-0 right-0 flex justify-around items-center z-40">
        <a href="/Lara/registros.html" class="nav-btn"><i data-lucide="list"></i>REGISTROS</a>
        <a href="/Lara/viajes.html" class="nav-btn"><i data-lucide="truck"></i>VIAJES</a>
        <a href="/Lara/diezmos.html" class="nav-btn"><i data-lucide="heart"></i>DIEZMOS</a>
        <a href="/Lara/resumen.html" class="nav-btn nav-active"><i data-lucide="pie-chart"></i>RESUMEN</a>
    </nav>

    <script>
        const formatter = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'GTQ', minimumFractionDigits: 0, maximumFractionDigits: 0 });
        function formatQ(n) { return formatter.format(n).replace('GTQ', 'Q'); }

        function render() {
            const records = JSON.parse(localStorage.getItem('registros') || '[]');
            
            // 1. Total Neto
            let totalIng = 0, totalGas = 0;
            const cats = {};
            const months = {};

            records.forEach(r => {
                const m = Number(r.monto);
                if(r.tipo === 'Ingreso') { totalIng += m; } else { totalGas += m; }

                // Categorías
                if(!cats[r.categoria]) cats[r.categoria] = { ing: 0, gas: 0 };
                if(r.tipo === 'Ingreso') cats[r.categoria].ing += m; else cats[r.categoria].gas += m;

                // Meses
                const monthKey = r.fecha.slice(0,7);
                if(!months[monthKey]) months[monthKey] = { ing: 0, gas: 0 };
                if(r.tipo === 'Ingreso') months[monthKey].ing += m; else months[monthKey].gas += m;
            });

            document.getElementById('total-neto').textContent = formatQ(totalIng - totalGas);

            // 2. Render Categorías
            const catContainer = document.getElementById('cat-list');
            catContainer.innerHTML = Object.keys(cats).map(c => {
                const neto = cats[c].ing - cats[c].gas;
                return `
                    <div class="flex justify-between items-center border-b border-slate-50 pb-2">
                        <div>
                            <p class="font-bold text-slate-700 text-sm">${c}</p>
                            <p class="text-[10px] text-slate-400">I: ${formatQ(cats[c].ing)} | G: ${formatQ(cats[c].gas)}</p>
                        </div>
                        <p class="font-black ${neto >= 0 ? 'text-emerald-500' : 'text-red-500'}">${formatQ(neto)}</p>
                    </div>
                `;
            }).join('');

            // 3. Render Meses
            const monthContainer = document.getElementById('month-list');
            monthContainer.innerHTML = Object.keys(months).sort().reverse().map(m => {
                const neto = months[m].ing - months[m].gas;
                return `
                    <div class="flex justify-between items-center border-b border-slate-50 pb-2">
                        <p class="font-bold text-slate-700 text-sm">${m}</p>
                        <p class="font-black ${neto >= 0 ? 'text-emerald-500' : 'text-red-500'}">${formatQ(neto)}</p>
                    </div>
                `;
            }).join('');
        }

        function exportJSON() {
            const data = {
                registros: JSON.parse(localStorage.getItem('registros') || '[]'),
                viajes: JSON.parse(localStorage.getItem('viajes') || '[]'),
                diezmos: JSON.parse(localStorage.getItem('pagos_diezmos') || '[]'),
                categorias: JSON.parse(localStorage.getItem('categorias') || '[]')
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `Lara_Backup_${new Date().toISOString().slice(0,10)}.json`;
            a.click();
        }

        function importJSON(e) {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = (ev) => {
                try {
                    const data = JSON.parse(ev.target.result);
                    localStorage.setItem('registros', JSON.stringify(data.registros || []));
                    localStorage.setItem('viajes', JSON.stringify(data.viajes || []));
                    localStorage.setItem('pagos_diezmos', JSON.stringify(data.diezmos || []));
                    localStorage.setItem('categorias', JSON.stringify(data.categorias || []));
                    location.reload();
                } catch(err) { alert("Error al importar"); }
            };
            reader.readAsText(file);
        }

        function exportPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.setFontSize(20);
            doc.text("Resumen Multi Servicios LARA", 20, 20);
            doc.setFontSize(12);
            doc.text(`Fecha de reporte: ${new Date().toLocaleDateString()}`, 20, 30);
            
            const records = JSON.parse(localStorage.getItem('registros') || '[]');
            let y = 45;
            doc.text("Últimos Registros:", 20, y);
            y += 10;
            records.slice(0, 20).forEach(r => {
                doc.text(`${r.fecha} - ${r.categoria}: ${r.tipo === 'Ingreso' ? '+' : '-'}${formatQ(r.monto)}`, 20, y);
                y += 7;
                if(y > 280) { doc.addPage(); y = 20; }
            });
            doc.save("Lara_Reporte.pdf");
        }

        function clearAll() {
            if(confirm("¿Borrar todos los datos?")) { localStorage.clear(); location.reload(); }
        }

        window.onload = () => { lucide.createIcons(); render(); };
    </script>
</body>
</html>
